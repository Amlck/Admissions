<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admission Note Builder - AI Enhanced</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css">
</head>
<body>
  <!-- App Header -->
  <header class="app-header">
    <div class="app-brand">
      <div class="app-logo">A</div>
      <div>
        <h1 class="app-title">Admission Note Builder</h1>
        <p class="app-subtitle">AI-Enhanced Clinical Documentation</p>
      </div>
    </div>
    <div class="header-actions">
      <div id="settings-container">
        <div id="settings-gear">‚â°</div>
        <div id="settings-menu">
          <h4>Settings</h4>
          <input type="file" id="background-input" accept="image/*" />
          <button onclick="document.getElementById('background-input').click();">Change Background</button>
          <button id="reset-background">Reset Background</button>
          <button id="clear-api-key">Reset API Key</button>
          <button id="clear-data">Clear for New Patient</button>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <p class="page-intro">Paste or dictate your clinical notes, and AI will structure them into the admission form. Review, edit, and copy to EMR.</p>

    <!-- AI Quick Entry Panel -->
    <div id="aiPanel">
      <h2>AI Quick Entry</h2>

      <div id="apiKeySetup">
        <label><strong>Gemini API Key</strong> (stored locally in your browser)</label>
        <input type="password" id="apiKeyInput" placeholder="Enter your Gemini API key..." />
        <button id="saveApiKey">Save Key</button>
        <span id="apiKeyStatus"></span>
      </div>

      <div id="modelSelector" style="margin-bottom: 12px;">
        <label><strong>Model:</strong>
          <select id="modelSelect" style="margin-left: 8px; padding: 4px 8px; border-radius: 4px; border: 1px solid #ccc;">
            <option value="gemini-3-pro-preview">Gemini 3 Pro (Best quality)</option>
            <option value="gemini-3-flash-preview">Gemini 3 Flash (Fast)</option>
            <option value="gemini-2.0-flash">Gemini 2.0 Flash (Stable)</option>
            <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
          </select>
        </label>
      </div>

      <textarea id="aiInputArea" placeholder="Paste your notes here, or click the microphone to dictate...

Example:
65 year old male with history of HTN, DM, presenting with chest pain for 2 hours. Pain is substernal, pressure-like, radiating to left arm. Associated with diaphoresis and shortness of breath. No similar episodes before. Denies fever, cough, abdominal pain.

On exam: alert, diaphoretic. BP 160/95, HR 88, T 36.5, RR 18. Heart regular, no murmur. Lungs clear. Abdomen soft. No leg edema.

PMH: HTN x 10 years on amlodipine, DM on metformin. No surgeries. NKDA. Father had MI at age 60. Non-smoker, occasional alcohol."></textarea>

      <!-- Image Upload Section -->
      <div id="imageUploadSection" style="margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
          <input type="file" id="imageInput" accept="image/*" style="display: none;" />
          <button id="imageUploadBtn" class="ai-btn" onclick="document.getElementById('imageInput').click();">
            <span>üì∑</span>
            <span>Upload Image</span>
          </button>
          <span id="imageFileName" style="color: #666; font-size: 0.9em;"></span>
          <button id="clearImageBtn" class="ai-btn" style="display: none;">
            <span>‚úï</span>
            <span>Remove</span>
          </button>
        </div>
        <div id="imagePreview" style="display: none; margin-top: 10px;">
          <img id="previewImg" style="max-width: 300px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;" />
        </div>
        <p style="font-size: 0.85em; color: #666; margin-top: 6px;">Upload photos of handwritten notes - AI will extract and parse the text.</p>
      </div>

      <div class="ai-button-row">
        <div class="lang-toggle">
          <span>üåê</span>
          <select id="voiceLang">
            <option value="zh-TW">‰∏≠Êñá</option>
            <option value="en-US">English</option>
          </select>
        </div>
        <button id="voiceBtn" class="ai-btn">
          <span id="voiceIcon">üé§</span>
          <span id="voiceText">ÈñãÂßãÈåÑÈü≥</span>
        </button>
        <button id="parseBtn" class="ai-btn" disabled>
          <span>ü§ñ</span>
          <span>Parse with AI</span>
        </button>
        <button id="clearAiBtn" class="ai-btn">
          <span>üóëÔ∏è</span>
          <span>Clear</span>
        </button>
      </div>

      <div id="aiStatus"></div>
      <div id="aiProgressContainer" style="display: none; margin-top: 10px;">
        <div id="aiProgressBar" style="height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden;">
          <div id="aiProgressFill" style="height: 100%; width: 0%; background: linear-gradient(90deg, #4285f4, #34a853); transition: width 0.3s ease-out;"></div>
        </div>
        <div id="aiProgressText" style="font-size: 0.85em; color: #666; margin-top: 4px; text-align: center;"></div>
      </div>
    </div>

    <div id="blockContainer"></div>
    <div id="modalOverlay">
      <div id="modalContent">
        <button id="modalClose">√ó</button>
        <div id="modalBody"></div>
      </div>
    </div>

    <!-- Hidden sections container -->
    <div id="sectionsContainer">
      <section id="chiefSection" data-title="Chief Complaint">
        <h2>Chief Complaint & Present Illness</h2>
        <label>Informant: <input type="text" id="informant" placeholder="Patient and medical records"/></label>
        <textarea id="ccpi" rows="5" placeholder="e.g., Symptoms for a length of time..."></textarea>
      </section>

      <section id="historySection" data-title="History">
        <h2>Routine History</h2>
        <h3>Patient History & Present Illness Narrative</h3>
        <textarea id="patientHistoryNarrative" rows="12" placeholder="e.g., This is a xx-year-old (wo)man with..."></textarea>
        <h3>Past Medical History (Structured)</h3>
        <textarea id="hist_pmh" rows="4" placeholder="1. Some kind of disease...
2. Some other kind of disease"></textarea>
        <h3>Medication Allergy</h3>
        <div style="margin-top:6px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
          <label class="toggle" style="flex-shrink: 0;"><input type="checkbox" id="hist_med_allergy_denied"/>Denied</label>
          <input type="text" id="hist_med_allergy_details" placeholder="Details (e.g., Penicillin, Rash)" style="flex-grow: 1; min-width: 150px;"/>
          <label style="flex-shrink: 0;">Date: <input type="text" id="hist_med_allergy_date" placeholder="YYYY/MM/DD" style="width: 120px;"/></label>
        </div>
        <h3>Medication ADR (Adverse Drug Reaction)</h3>
        <textarea id="hist_med_adr" rows="1" placeholder="unknown"></textarea>
        <h3>Allergy to Medical Device and Materials</h3>
        <div style="margin-top:6px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
          <label class="toggle" style="flex-shrink: 0;"><input type="checkbox" id="hist_device_allergy_denied"/>Denied</label>
          <input type="text" id="hist_device_allergy_details" placeholder="Details (e.g., Latex, Swelling)" style="flex-grow: 1; min-width: 150px;"/>
          <label style="flex-shrink: 0;">Date: <input type="text" id="hist_device_allergy_date" placeholder="YYYY/MM/DD" style="width: 120px;"/></label>
        </div>
        <h3>Current Medication</h3>
        <label>Âè∞Â§ßÈÜ´Èô¢ (Usually auto-filled): <input type="text" id="hist_current_med_ntuh" placeholder="Can be left blank or used for copy-paste"/></label>
        <label>Other: <input type="text" id="hist_current_med_other" placeholder="denied"/></label>
        <label>‰∏≠ËçâËó• (TCM): <input type="text" id="hist_current_med_tcm" placeholder="denied"/></label>
        <label>‰øùÂÅ•È£üÂìÅ (Supplements): <input type="text" id="hist_current_med_supplements" placeholder="denied"/></label>
        <h3>Hospitalization History</h3>
        <textarea id="hist_hospitalization_history" rows="4" placeholder="e.g., ÂÖ•Èô¢Êó•Êúü:YYYY_MM_DD Âá∫Èô¢Êó•Êúü:YYYY_MM_DD Ë®∫Êñ∑:"></textarea>
        <h3>Past Surgical History</h3>
        <textarea id="hist_surgical_history_detailed" rows="3" placeholder="denied"></textarea>
        <h3>Family History</h3>
        <div class="grid" id="fhGrid">
          <label class="toggle"><input type="checkbox" id="fh_HTN" />Hypertension</label>
          <label class="toggle"><input type="checkbox" id="fh_DM" />Diabetes</label>
          <label class="toggle"><input type="checkbox" id="fh_DLP" />Dyslipidemia</label>
          <label class="toggle"><input type="checkbox" id="fh_CA" />Cancer</label>
          <label class="toggle"><input type="checkbox" id="fh_CAD" />CAD</label>
        </div>
        <label>Family History Details:
          <textarea id="fh_details" rows="2" placeholder="e.g., Grandfather: DM, HTN
Grandmother: DM, HTN"></textarea>
        </label>
        <h3>TOCC</h3>
        <details>
          <summary>Travel, Occupation, Contact, Cluster</summary>
          <div style="margin-top:6px;">
            <label>Travel: <input type="text" id="hist_tocc_travel" placeholder="denied"/></label><br/>
            <label>Occupation: <input type="text" id="hist_tocc_occupation" placeholder="Office worker"/></label><br/>
            <label>Cluster and contact: <input type="text" id="hist_tocc_cluster" placeholder="denied"/></label>
          </div>
        </details>
        <h3>ABC</h3>
        <details>
          <summary>Personal Habits</summary>
          <div style="margin-top:6px;">
            <label>Alcohol: <input type="text" id="hist_abc_alcohol" placeholder="denied"/></label><br/>
            <label>Betel nuts: <input type="text" id="hist_abc_betel" placeholder="denied"/></label><br/>
            <label>Smoking: <input type="text" id="hist_abc_smoking" placeholder="denied"/></label>
          </div>
        </details>
      </section>

      <section id="psychosocialSection" data-title="Psychosocial">
        <h2>Á§æÊúÉÂøÉÁêÜÁõ∏ÈóúË©ï‰º∞ (Psychosocial Assessment)</h2>
        <textarea id="psychosocial_assessment" rows="2" placeholder="pending"></textarea>
      </section>

      <section id="dischargePlanningSection" data-title="Discharge Plan">
        <h2>Âá∫Èô¢Ë¶èÂäÉ (Discharge Planning)</h2>
        <div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
          <label>ÁÆ°Ë∑ØÁïôÁΩÆÁãÄÊ≥ÅÔºö<input type="text" id="dp_catheter" placeholder="Nil"/></label>
          <label>Êó•Â∏∏ÁîüÊ¥ªÂäüËÉΩÂàÜÊï∏Ôºö<input type="text" id="dp_adl" placeholder="100"/></label>
          <label>È†êÊúüÂá∫Èô¢ÂæåÂ±Ö‰ΩèÂ†¥ÊâÄÔºö<input type="text" id="dp_residence" placeholder="ËàáÂÆ∂‰∫∫Âêå‰Ωè"/></label>
          <label>È†êÊúüÂá∫Èô¢Âæå‰∏ªË¶ÅÁÖßÈ°ßËÄÖÔºö<input type="text" id="dp_caregiver" placeholder="Ëá™Â∑±"/></label>
          <label>Âá∫Èô¢Ë¶èÂäÉÊî∂Ê°àÁØ©Ê™¢Ôºö<input type="text" id="dp_screening" placeholder="‰∏ÄËà¨ÁóÖÊÇ£"/></label>
        </div>
      </section>

      <section id="vitalsSection" data-title="Vitals">
        <h2>Vitals</h2>
        <div class="vitals-grid">
          <label>Height (cm): <input type="text" id="vitals_bh"/></label>
          <label>Weight (kg): <input type="text" id="vitals_bw"/></label>
          <label>Temp (¬∞C): <input type="text" id="vitals_t"/></label>
          <label>Pulse (bpm): <input type="text" id="vitals_p"/></label>
          <label>Resp (/min): <input type="text" id="vitals_r"/></label>
          <label>BP (mmHg): <input type="text" id="vitals_bp"/></label>
          <label>Pain Score: <input type="text" id="vitals_pain"/></label>
        </div>
      </section>

      <section id="peSection" data-title="Physical Exam">
        <h2>Physical Examination</h2>
        <h3>PE Narrative / General Appearance</h3>
        <textarea id="pe_details" rows="3" placeholder="e.g., General appearance: fair body figure
breathing sound: crackles(+, right upper lobe)"></textarea>
        <details open>
          <summary>Neurological Examination</summary>
          <div style="margin-top:6px;">
            <label>Consciousness: <input type="text" id="pe_neuro_conscious" placeholder="alert and oriented, GCS: E4M6V5"/></label><br/>
            <label>Muscle power: <input type="text" id="pe_neuro_power" placeholder="can not perform"/></label><br/>
            <label>Gait: <input type="text" id="pe_neuro_gait" placeholder="no test"/></label>
          </div>
        </details>
        <details>
          <summary>HEENT</summary>
          <div class="grid">
            <label class="toggle"><input type="checkbox" id="pe_head_raccoon"/>Raccoon eye</label>
            <label class="toggle"><input type="checkbox" id="pe_head_rash"/>Rash</label>
            <label class="toggle"><input type="checkbox" id="pe_pupil_abn"/>Pupil abnormal</label>
            <label class="toggle"><input type="checkbox" id="pe_eom_lim"/>EOM limited</label>
            <label class="toggle"><input type="checkbox" id="pe_conj_pale"/>Conjunctiva pale</label>
            <label class="toggle"><input type="checkbox" id="pe_sclera_icteric"/>Sclera icteric</label>
            <label class="toggle"><input type="checkbox" id="pe_ear_def"/>Ear deformity</label>
            <label class="toggle"><input type="checkbox" id="pe_ear_dis"/>Ear discharge</label>
            <label class="toggle"><input type="checkbox" id="pe_ear_hi"/>Hearing impairment</label>
            <label class="toggle"><input type="checkbox" id="pe_throat_mass"/>Throat mass</label>
            <label class="toggle"><input type="checkbox" id="pe_throat_ulcer"/>Throat ulcer</label>
            <label class="toggle"><input type="checkbox" id="pe_throat_ng"/>NG tube</label>
          </div>
        </details>
        <details>
          <summary>Neck</summary>
          <div class="grid">
            <label class="toggle"><input type="checkbox" id="pe_neck_stiff"/>Stiffness</label>
            <label class="toggle"><input type="checkbox" id="pe_neck_bruit"/>Bruit</label>
            <label class="toggle"><input type="checkbox" id="pe_neck_jvp"/>Jugular engorgement</label>
            <label class="toggle"><input type="checkbox" id="pe_neck_goiter"/>Goiter</label>
            <label class="toggle"><input type="checkbox" id="pe_neck_lymph"/>Lymphadenopathy</label>
          </div>
        </details>
        <details>
          <summary>Chest</summary>
          <div class="grid">
            <label class="toggle"><input type="checkbox" id="pe_chest_def"/>Chest deformity</label>
            <label class="toggle"><input type="checkbox" id="pe_chest_spider"/>Spider angioma</label>
            <label class="toggle"><input type="checkbox" id="pe_chest_lump"/>Lumps</label>
            <label class="toggle"><input type="checkbox" id="pe_chest_discharge"/>Discharge</label>
            <label class="toggle"><input type="checkbox" id="pe_chest_tender"/>Tenderness</label>
            <label class="toggle"><input type="checkbox" id="pe_chest_crackles"/>Crackles</label>
            <label class="toggle"><input type="checkbox" id="pe_chest_wheeze"/>Wheezing</label>
            <label class="toggle"><input type="checkbox" id="pe_chest_rhonchi"/>Rhonchi</label>
            <label class="toggle"><input type="checkbox" id="pe_chest_stridor"/>Stridor</label>
          </div>
        </details>
        <details>
          <summary>Heart</summary>
          <div class="grid">
            <label class="toggle"><input type="checkbox" id="pe_heart_irreg"/>Irregular beat</label>
            <label class="toggle"><input type="checkbox" id="pe_heart_murmur"/>Murmur</label>
            <label class="toggle"><input type="checkbox" id="pe_heart_thrill"/>Thrill</label>
            <label class="toggle"><input type="checkbox" id="pe_heart_pmi"/>Abnormal PMI</label>
          </div>
        </details>
        <details>
          <summary>Abdomen</summary>
          <div class="grid">
            <label class="toggle"><input type="checkbox" id="pe_abd_dist"/>Distension</label>
            <label class="toggle"><input type="checkbox" id="pe_abd_caput"/>Caput medusa</label>
            <label class="toggle"><input type="checkbox" id="pe_abd_mass"/>Palpable mass</label>
            <label class="toggle"><input type="checkbox" id="pe_abd_tender"/>Tenderness</label>
            <label class="toggle"><input type="checkbox" id="pe_abd_hjr"/>Hepato-jugular reflux</label>
          </div>
        </details>
        <details>
          <summary>Back</summary>
          <div class="grid">
            <label class="toggle"><input type="checkbox" id="pe_back_cv"/>CV angle knocking pain</label>
          </div>
        </details>
        <details>
          <summary>Extremities</summary>
          <div class="grid">
            <label class="toggle"><input type="checkbox" id="pe_ext_lim"/>Limitation of movement</label>
            <label class="toggle"><input type="checkbox" id="pe_ext_def"/>Deformity</label>
            <label class="toggle"><input type="checkbox" id="pe_ext_cyano"/>Cyanosis</label>
            <label class="toggle"><input type="checkbox" id="pe_ext_edema"/>Pitting edema</label>
          </div>
        </details>
        <details>
          <summary>Skin</summary>
          <div class="grid">
            <label class="toggle"><input type="checkbox" id="pe_skin_rash"/>Rash</label>
            <label class="toggle"><input type="checkbox" id="pe_skin_tumor"/>Tumor</label>
            <label class="toggle"><input type="checkbox" id="pe_skin_pete"/>Petechiae</label>
            <label class="toggle"><input type="checkbox" id="pe_skin_ecch"/>Ecchymosis</label>
            <label class="toggle"><input type="checkbox" id="pe_skin_purp"/>Purpura</label>
            <label class="toggle"><input type="checkbox" id="pe_skin_depig"/>Depigmentation</label>
            <label class="toggle"><input type="checkbox" id="pe_skin_hyperpig"/>Abnormal pigmentation</label>
            <label class="toggle"><input type="checkbox" id="pe_skin_tel"/>Telangiectasia</label>
          </div>
        </details>
      </section>

      <section id="rosSection" data-title="Review of Systems">
        <h2>Review of Systems (ROS)</h2>
        <h3>ROS Details</h3>
        <textarea id="ros_details" rows="2" placeholder="e.g., Respiratory: dyspnea(-), chest pain(-), productive cough (+, for 6 months)"></textarea>
        <details open>
          <summary>Systemic</summary>
          <div class="grid">
            <label class="toggle"><input type="checkbox" id="ros_sys_fever"/>fever</label>
            <label class="toggle"><input type="checkbox" id="ros_sys_chills"/>chills</label>
            <label class="toggle"><input type="checkbox" id="ros_sys_night_sweats"/>night sweats</label>
            <label class="toggle"><input type="checkbox" id="ros_sys_fatigue"/>fatigue</label>
            <label class="toggle"><input type="checkbox" id="ros_sys_conscious_dist"/>consciousness disturbance</label>
            <label class="toggle"><input type="checkbox" id="ros_sys_insomnia"/>insomnia</label>
            <label class="toggle"><input type="checkbox" id="ros_sys_weight_change"/>weight change</label>
            <label class="toggle"><input type="checkbox" id="ros_sys_appetite_dec"/>decreased appetite</label>
          </div>
        </details>
        <details>
          <summary>HEENT</summary>
          <div class="grid">
            <label class="toggle"><input type="checkbox" id="ros_heent_headache"/>headache</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_dizziness"/>dizziness</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_vertigo"/>vertigo</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_diplopia"/>diplopia</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_visual_field_defect"/>visual field defect</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_blurred_vision"/>blurred vision</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_ocular_pain"/>ocular pain</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_tinnitus"/>tinnitus</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_otalgia"/>otalgia</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_otorrhea"/>otorrhea</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_hearing_impairment"/>hearing impairment</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_nasal_congestion"/>nasal congestion</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_nasal_discharge"/>nasal discharge</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_sore_throat"/>sore throat</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_gum_bleeding"/>gum bleeding</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_dysphagia"/>dysphagia</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_hoarseness"/>hoarseness</label>
            <label class="toggle"><input type="checkbox" id="ros_heent_oral_ulcers"/>oral ulcers</label>
          </div>
        </details>
        <details>
          <summary>Cardiorespiratory</summary>
          <div class="grid">
            <label class="toggle"><input type="checkbox" id="ros_cardio_chest_pain"/>chest pain</label>
            <label class="toggle"><input type="checkbox" id="ros_cardio_exertional_dyspnea"/>exertional dyspnea</label>
            <label class="toggle"><input type="checkbox" id="ros_cardio_nocturnal_dyspnea"/>nocturnal dyspnea</label>
            <label class="toggle"><input type="checkbox" id="ros_cardio_orthopnea"/>orthopnea</label>
            <label class="toggle"><input type="checkbox" id="ros_cardio_pitting_edema"/>pitting edema</label>
            <label class="toggle"><input type="checkbox" id="ros_cardio_syncope"/>syncope</label>
            <label class="toggle"><input type="checkbox" id="ros_cardio_palpitation"/>palpitation</label>
            <label class="toggle"><input type="checkbox" id="ros_cardio_intermittent_claudication"/>intermittent claudication</label>
            <label class="toggle"><input type="checkbox" id="ros_cardio_dyspnea"/>dyspnea</label>
            <label class="toggle"><input type="checkbox" id="ros_cardio_cough"/>cough</label>
            <label class="toggle"><input type="checkbox" id="ros_cardio_sputum"/>sputum</label>
            <label class="toggle"><input type="checkbox" id="ros_cardio_hemoptysis"/>hemoptysis</label>
            <label class="toggle"><input type="checkbox" id="ros_cardio_wheezes"/>wheezes</label>
            <label class="toggle"><input type="checkbox" id="ros_cardio_chest_tightness"/>chest tightness</label>
          </div>
        </details>
        <details>
          <summary>Gastrointestinal</summary>
          <div class="grid">
            <label class="toggle"><input type="checkbox" id="ros_gi_anorexia"/>anorexia</label>
            <label class="toggle"><input type="checkbox" id="ros_gi_nausea"/>nausea</label>
            <label class="toggle"><input type="checkbox" id="ros_gi_vomiting"/>vomiting</label>
            <label class="toggle"><input type="checkbox" id="ros_gi_acid_regurgitation"/>acid regurgitation</label>
            <label class="toggle"><input type="checkbox" id="ros_gi_abdominal_pain"/>abdominal pain</label>
            <label class="toggle"><input type="checkbox" id="ros_gi_abdominal_distention"/>abdominal distention</label>
            <label class="toggle"><input type="checkbox" id="ros_gi_dysphagia"/>dysphagia</label>
            <label class="toggle"><input type="checkbox" id="ros_gi_dyspepsia"/>dyspepsia</label>
            <label class="toggle"><input type="checkbox" id="ros_gi_hematemesis"/>hematemesis</label>
            <label class="toggle"><input type="checkbox" id="ros_gi_diarrhea"/>diarrhea</label>
            <label class="toggle"><input type="checkbox" id="ros_gi_constipation"/>constipation</label>
            <label class="toggle"><input type="checkbox" id="ros_gi_melena"/>melena</label>
            <label class="toggle"><input type="checkbox" id="ros_gi_hematochezia"/>hematochezia</label>
            <label class="toggle"><input type="checkbox" id="ros_gi_tenesmus"/>tenesmus</label>
            <label class="toggle"><input type="checkbox" id="ros_gi_small_caliber_stool"/>small caliber stool</label>
          </div>
        </details>
        <details>
          <summary>Genitourinary</summary>
          <div class="grid">
            <label class="toggle"><input type="checkbox" id="ros_gu_urinary_frequency"/>urinary frequency</label>
            <label class="toggle"><input type="checkbox" id="ros_gu_urgency"/>urgency</label>
            <label class="toggle"><input type="checkbox" id="ros_gu_nocturia"/>nocturia</label>
            <label class="toggle"><input type="checkbox" id="ros_gu_incontinence"/>incontinence</label>
            <label class="toggle"><input type="checkbox" id="ros_gu_weak_stream"/>weak urinary stream</label>
            <label class="toggle"><input type="checkbox" id="ros_gu_hesitancy"/>hesitancy</label>
            <label class="toggle"><input type="checkbox" id="ros_gu_incomplete_voiding"/>incomplete voiding</label>
            <label class="toggle"><input type="checkbox" id="ros_gu_terminal_dribbling"/>terminal dribbling</label>
            <label class="toggle"><input type="checkbox" id="ros_gu_dysuria"/>dysuria</label>
            <label class="toggle"><input type="checkbox" id="ros_gu_hematuria"/>hematuria</label>
            <label class="toggle"><input type="checkbox" id="ros_gu_flank_pain"/>flank pain</label>
            <label class="toggle"><input type="checkbox" id="ros_gu_polyuria"/>polyuria</label>
            <label class="toggle"><input type="checkbox" id="ros_gu_oliguria"/>oliguria</label>
          </div>
        </details>
        <details>
          <summary>Musculoskeletal</summary>
          <div class="grid">
            <label class="toggle"><input type="checkbox" id="ros_msk_arthralgia"/>arthralgia</label>
            <label class="toggle"><input type="checkbox" id="ros_msk_joint_stiffness"/>joint stiffness</label>
            <label class="toggle"><input type="checkbox" id="ros_msk_joint_swelling"/>joint swelling</label>
            <label class="toggle"><input type="checkbox" id="ros_msk_myalgia"/>myalgia</label>
            <label class="toggle"><input type="checkbox" id="ros_msk_cramps"/>cramps</label>
            <label class="toggle"><input type="checkbox" id="ros_msk_bone_pain"/>bone pain</label>
            <label class="toggle"><input type="checkbox" id="ros_msk_back_pain"/>back pain</label>
            <label class="toggle"><input type="checkbox" id="ros_msk_fractures"/>fractures</label>
          </div>
        </details>
        <details>
          <summary>Nervous</summary>
          <div class="grid">
            <label class="toggle"><input type="checkbox" id="ros_neuro_blurred_vision"/>blurred vision</label>
            <label class="toggle"><input type="checkbox" id="ros_neuro_hearing_impairment"/>hearing impairment</label>
            <label class="toggle"><input type="checkbox" id="ros_neuro_speech_problem"/>speech problem</label>
            <label class="toggle"><input type="checkbox" id="ros_neuro_numbness"/>numbness</label>
            <label class="toggle"><input type="checkbox" id="ros_neuro_paraesthesia"/>paraesthesia</label>
            <label class="toggle"><input type="checkbox" id="ros_neuro_allodynia"/>allodynia</label>
            <label class="toggle"><input type="checkbox" id="ros_neuro_paresis_plegia"/>paresis/plegia</label>
            <label class="toggle"><input type="checkbox" id="ros_neuro_gait_disturbance"/>gait disturbance</label>
            <label class="toggle"><input type="checkbox" id="ros_neuro_sphincter_disturbance"/>sphincter disturbance</label>
            <label class="toggle"><input type="checkbox" id="ros_neuro_convulsion"/>convulsion</label>
            <label class="toggle"><input type="checkbox" id="ros_neuro_resting_tremor"/>resting tremor</label>
          </div>
        </details>
        <details>
          <summary>Skin</summary>
          <div class="grid">
            <label class="toggle"><input type="checkbox" id="ros_skin_color_changes"/>color changes</label>
            <label class="toggle"><input type="checkbox" id="ros_skin_jaundice"/>jaundice</label>
            <label class="toggle"><input type="checkbox" id="ros_skin_rash"/>rash</label>
            <label class="toggle"><input type="checkbox" id="ros_skin_itching"/>itching</label>
            <label class="toggle"><input type="checkbox" id="ros_skin_petechiae"/>petechiae</label>
            <label class="toggle"><input type="checkbox" id="ros_skin_ecchymoses"/>ecchymoses</label>
            <label class="toggle"><input type="checkbox" id="ros_skin_purpura"/>purpura</label>
          </div>
        </details>
      </section>

      <section id="imagingSection" data-title="Imaging Report">
        <h2>ÂΩ±ÂÉèÂ†±Âëä (Imaging Report)</h2>
        <textarea id="imaging_report" rows="6" placeholder="e.g., MRI Head and Neck 2026/01/09: No definite local tumour recurrence. No enlarged cervical lymph nodes.

CXR 2026/01/09: No cardiomegaly, no obvious pneumonia patch."></textarea>
      </section>

      <section id="pathologySection" data-title="Pathology Report">
        <h2>ÁóÖÁêÜÂ†±Âëä (Pathology Report)</h2>
        <textarea id="pathology_report" rows="4" placeholder="nil (if no pathology report)"></textarea>
      </section>

      <section id="diagnosisSection" data-title="Tentative Diagnosis">
        <h2>ËáÜÊñ∑ (Tentative Diagnosis)</h2>
        <h3>[Active]</h3>
        <textarea id="diagnosis_active" rows="3" placeholder="#. Main diagnosis for this admission
- status post treatment if applicable"></textarea>
        <h3>[Underlying]</h3>
        <textarea id="diagnosis_underlying" rows="4" placeholder="#. Underlying condition 1
#. Underlying condition 2
#. Underlying condition 3"></textarea>
      </section>

      <section id="planSection" data-title="SOAP Note">
        <h2>ÈÜ´ÁôÇÈúÄÊ±ÇËàáÊ≤ªÁôÇË®àÁï´ (Medical Needs and Care Plan)</h2>
        <label>Age and sex: <input type="text" id="plan_age_sex" placeholder="e.g., 99F"></label>
        <h3 style="margin-top:20px;">S: Subjective</h3>
        <p style="padding: 10px 12px; background: #e9ecef; border-radius: var(--radius); border: 1px solid var(--border);">This will be auto-filled from the Chief Complaint section.</p>
        <h3 style="margin-top:20px;">O: Objective</h3>
        <h4>Key Physical Examination Findings</h4>
        <textarea id="plan_pe_findings" rows="2" placeholder="e.g., breathing sound: crackles(+, somewhere out there)"></textarea>
        <h4>Lab</h4>
        <textarea id="plan_lab_data" rows="4" placeholder="Significant lab data"></textarea>
        <h4>EKG</h4>
        <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
          <label style="flex-basis: 200px;">Date: <input type="text" id="plan_ekg_date" placeholder="YYYY/MM/DD"></label>
          <label style="flex-grow: 1;">Interpretation: <input type="text" id="plan_ekg_interp" placeholder="Normal sinus rhythm"></label>
        </div>
        <h4>CXR</h4>
        <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap; margin-top: 8px;">
          <label style="flex-basis: 200px;">Date: <input type="text" id="plan_cxr_date" placeholder="YYYY/MM/DD"></label>
          <label style="flex-grow: 1;">Interpretation: <input type="text" id="plan_cxr_interp" placeholder="No cardiomegaly. No obvious pneumonia patch."></label>
        </div>
        <h3 style="margin-top:20px;">A: Assessment</h3>
        <h4>Active Problems</h4>
        <textarea id="plan_assessment_active" rows="2" placeholder="#. Fever, suspect infection..."></textarea>
        <h4>Underlying Conditions</h4>
        <textarea id="plan_assessment_underlying" rows="3" placeholder="I think I saw this somewhere..."></textarea>
        <h3 style="margin-top:20px;">P: Plan</h3>
        <textarea id="plan_plan" rows="3" placeholder="1. Keep current treatment...
2. Check some kind of lab
3. Arrange some kind of test"></textarea>
        <label>Treatment Goal: <input type="text" id="plan_treatment_goal" placeholder="Resolve symptoms and discharge without complications"/></label>
      </section>
    </div>

    <div id="controls">
      <div class="button-group">
        <button id="copyHistoryBtn" class="button">Copy History Block</button>
        <button id="copyFullNoteBtn" class="button">Copy Full Note</button>
      </div>
      <h2>Output Preview</h2>
      <div id="noteOutputContainer">
        <div id="noteOutput"></div>
      </div>
    </div>

    <div id="copy-toast">Note Copied!</div>
  </main>

  <script>
/**
 * Admission Note Builder - Bundled Version
 * All modules combined for file:// protocol compatibility
 */

// ============================================================================
// CONFIG
// ============================================================================
const CONFIG = {
  STORAGE_KEYS: {
    DATA: 'admissionNoteData_AI',
    BACKGROUND: 'admissionNoteBackground',
    API_KEY: 'geminiApiKey'
  },
  API: {
    BASE_URL: 'https://generativelanguage.googleapis.com/v1beta/models',
    MODEL: 'gemini-3-cpro-preview',
    MAX_OUTPUT_TOKENS: 8192,
    TEMPERATURE: 0.1
  },
  RETRY: {
    MAX_ATTEMPTS: 3,
    INITIAL_DELAY_MS: 1000,
    MAX_DELAY_MS: 10000,
    BACKOFF_MULTIPLIER: 2
  },
  VOICE: {
    LANGUAGES: { CHINESE: 'zh-TW', ENGLISH: 'en-US' },
    DEFAULT_LANGUAGE: 'zh-TW'
  },
  UI: {
    TOAST_DURATION_MS: 2000,
    STATUS_HIDE_DELAY_MS: 3000,
    MODAL_ANIMATION_MS: 300,
    DEBOUNCE_DELAY_MS: 500
  }
};

const AI_PROMPT_TEMPLATE = `Parse clinical notes to JSON for NTUH EMR. Output in ENGLISH only (translate Chinese if needed). Use null for missing info.

IMPORTANT - NO ABBREVIATIONS: Always expand medical abbreviations to full terms. Examples:
- HTN ‚Üí Hypertension
- DM ‚Üí Diabetes Mellitus
- CAD ‚Üí Coronary Artery Disease
- N/V ‚Üí Nausea/Vomiting
- ABx ‚Üí Antibiotics
- Rx ‚Üí Treatment/Prescription
- Hx ‚Üí History
- Dx ‚Üí Diagnosis


IMPORTANT: If an image is provided, first extract ALL text from the image (including handwritten notes). The image may contain handwritten clinical notes - carefully read and transcribe everything visible. Then parse the combined text content.

Extract these fields:
- chief_complaint: brief chief complaint for admission
- age_sex: format as "*49M" or "*65F" (asterisk + age + sex)
- patient_narrative: format as "This is a XX-year-old male/female with underlying disease of\\n#. Disease 1\\n#. Disease 2\\n\\nThe patient was..."
- past_medical_history: numbered list with #. prefix
- past_surgical_history: format as "YYYY_MM_DD  Procedure name"
- hospitalization_history: format as "ÂÖ•Èô¢Êó•Êúü:YYYY_MM_DD Âá∫Èô¢Êó•Êúü:YYYY_MM_DD Ë®∫Êñ∑:..."
- medication_allergy: {denied: boolean, details: string}
- current_medications: string
- family_history: {HTN, DM, DLP, Cancer, CAD, details}
- social_history: {alcohol, smoking, betel} - use "denied" or describe
- tocc: {travel, occupation, contact, cluster}
- vitals: {temperature, pulse, respiration, bp, height, weight, pain}
- physical_exam: {general, consciousness, chest, heart, abdomen, extremities, neurological, local_findings}

Generate Tentative Diagnosis (ËáÜÊñ∑):
- diagnosis_active: format as "[Active]\\n#. Main problem for admission\\n- status post treatment if any"
- diagnosis_underlying: format as "[Underlying]\\n#. Condition 1\\n#. Condition 2"

Generate SOAP for Medical Needs and Care Plan (ÈÜ´ÁôÇÈúÄÊ±ÇËàáÊ≤ªÁôÇË®àÁï´):
- soap_s: chief complaint in bullet format "- symptom noted during..."
- soap_o_general: format as "[General]\\n- code : full/aggressive\\n- vital signs: stable/unstable\\n- Consciousness: E4V5M6"
- soap_o_local: "[Local findings]\\n- describe relevant findings"
- soap_o_lab: "[lab]\\n- Hemogram: ...\\n- BCS: ..."
- soap_o_image: "[image]\\n- CXR (-)\\n- ECG : NSR"
- soap_a_active: same as diagnosis_active
- soap_a_underlying: same as diagnosis_underlying
- soap_plan: format as "- treatment step 1\\n- treatment step 2\\n- monitoring plan"
- treatment_goal: "- goal description"

Notes:
{{CLINICAL_NOTES}}

Return only valid JSON.`;

// ============================================================================
// ERROR HANDLING
// ============================================================================
class AppError extends Error {
  constructor(message, code, details = null) {
    super(message);
    this.name = 'AppError';
    this.code = code;
    this.details = details;
    this.timestamp = new Date().toISOString();
  }
}

class ApiError extends AppError {
  constructor(message, statusCode, response = null) {
    super(message, 'API_ERROR', { statusCode, response });
    this.name = 'ApiError';
    this.statusCode = statusCode;
  }
}

class NetworkError extends AppError {
  constructor(message, originalError = null) {
    super(message, 'NETWORK_ERROR', { originalError: originalError?.message });
    this.name = 'NetworkError';
  }
}

class ValidationError extends AppError {
  constructor(message, field = null) {
    super(message, 'VALIDATION_ERROR', { field });
    this.name = 'ValidationError';
  }
}

const ERROR_MESSAGES = {
  400: 'Invalid request. Please check your input and try again.',
  401: 'Invalid API key. Please check your Gemini API key.',
  403: 'Access denied. Your API key may not have the required permissions.',
  404: 'API endpoint not found. The service may be temporarily unavailable.',
  429: 'Rate limit exceeded. Please wait a moment before trying again.',
  500: 'Server error. The AI service is experiencing issues.',
  502: 'Bad gateway. The AI service is temporarily unavailable.',
  503: 'Service unavailable. Please try again later.',
  NETWORK_ERROR: 'Network error. Please check your internet connection.',
  OFFLINE: 'You appear to be offline. Please check your connection.',
  UNKNOWN: 'An unexpected error occurred. Please try again.'
};

function getErrorMessage(error) {
  if (error instanceof ApiError) return ERROR_MESSAGES[error.statusCode] || ERROR_MESSAGES.UNKNOWN;
  if (error instanceof NetworkError) return !navigator.onLine ? ERROR_MESSAGES.OFFLINE : ERROR_MESSAGES.NETWORK_ERROR;
  if (error instanceof ValidationError) return error.message || ERROR_MESSAGES.UNKNOWN;
  return error.message || ERROR_MESSAGES.UNKNOWN;
}

function logError(error, context = {}) {
  console.error('[AdmissionNoteBuilder Error]', { name: error.name, message: error.message, code: error.code, context, timestamp: new Date().toISOString() });
}

function isRetryableError(error) {
  if (error instanceof NetworkError) return true;
  if (error instanceof ApiError) return [429, 500, 502, 503].includes(error.statusCode);
  return false;
}

function calculateRetryDelay(attempt, config) {
  const delay = Math.min(config.INITIAL_DELAY_MS * Math.pow(config.BACKOFF_MULTIPLIER, attempt), config.MAX_DELAY_MS);
  return delay + Math.random() * 1000;
}

// ============================================================================
// UTILITIES
// ============================================================================
const getVal = (id, defaultVal = 'N/A') => {
  const el = document.getElementById(id);
  return el && el.value.trim() ? el.value.trim() : defaultVal;
};

const plusMinus = (cbId) => {
  const el = document.getElementById(cbId);
  return el && el.checked ? '‚ñ†' : '‚ñ°';
};

function debounce(func, wait) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func(...args), wait);
  };
}

function sanitizeHTML(text) {
  if (!text) return '';
  return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
}

const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
const isOnline = () => navigator.onLine;

function safeJsonParse(jsonString, defaultValue = null) {
  try { return JSON.parse(jsonString); } catch (e) { return defaultValue; }
}

function extractJsonFromText(text) {
  let jsonStr = text;
  if (text.includes('```json')) jsonStr = text.split('```json')[1].split('```')[0];
  else if (text.includes('```')) jsonStr = text.split('```')[1].split('```')[0];
  jsonStr = jsonStr.trim();

  // Try to repair truncated JSON (for Gemini 3 models that may truncate)
  if (!isValidJson(jsonStr)) {
    jsonStr = repairTruncatedJson(jsonStr);
  }
  return jsonStr;
}

function isValidJson(str) {
  try { JSON.parse(str); return true; } catch { return false; }
}

function repairTruncatedJson(jsonStr) {
  // Count open/close braces and brackets
  let braceCount = 0, bracketCount = 0, inString = false, escapeNext = false;
  for (let i = 0; i < jsonStr.length; i++) {
    const c = jsonStr[i];
    if (escapeNext) { escapeNext = false; continue; }
    if (c === '\\') { escapeNext = true; continue; }
    if (c === '"') { inString = !inString; continue; }
    if (inString) continue;
    if (c === '{') braceCount++;
    else if (c === '}') braceCount--;
    else if (c === '[') bracketCount++;
    else if (c === ']') bracketCount--;
  }

  // If we're in a string, try to close it
  if (inString) {
    // Find last incomplete string and truncate there
    const lastQuote = jsonStr.lastIndexOf('"');
    if (lastQuote > 0) {
      // Check if this quote starts a value
      const beforeQuote = jsonStr.substring(0, lastQuote).trim();
      if (beforeQuote.endsWith(':') || beforeQuote.endsWith(',') || beforeQuote.endsWith('[')) {
        jsonStr = jsonStr.substring(0, lastQuote) + 'null';
      } else {
        jsonStr = jsonStr.substring(0, lastQuote + 1);
      }
    }
  }

  // Recount after string fix
  braceCount = 0; bracketCount = 0; inString = false; escapeNext = false;
  for (let i = 0; i < jsonStr.length; i++) {
    const c = jsonStr[i];
    if (escapeNext) { escapeNext = false; continue; }
    if (c === '\\') { escapeNext = true; continue; }
    if (c === '"') { inString = !inString; continue; }
    if (inString) continue;
    if (c === '{') braceCount++;
    else if (c === '}') braceCount--;
    else if (c === '[') bracketCount++;
    else if (c === ']') bracketCount--;
  }

  // Close unclosed brackets and braces
  while (bracketCount > 0) { jsonStr += ']'; bracketCount--; }
  while (braceCount > 0) { jsonStr += '}'; braceCount--; }

  console.log('[JSON Repair] Applied truncation repair');
  return jsonStr;
}

// ============================================================================
// STORAGE
// ============================================================================
function saveToStorage(key, value) {
  try {
    localStorage.setItem(key, typeof value === 'object' ? JSON.stringify(value) : value);
  } catch (error) {
    logError(error, { key });
  }
}

function loadFromStorage(key, defaultValue = null) {
  try {
    const item = localStorage.getItem(key);
    if (item === null) return defaultValue;
    const parsed = safeJsonParse(item, null);
    return parsed !== null ? parsed : item;
  } catch (error) {
    return defaultValue;
  }
}

function removeFromStorage(key) {
  try { localStorage.removeItem(key); } catch (error) { }
}

const FormDataManager = {
  save(formElements) {
    const data = {};
    formElements.forEach(el => { if (el.id) data[el.id] = el.type === 'checkbox' ? el.checked : el.value; });
    saveToStorage(CONFIG.STORAGE_KEYS.DATA, data);
  },
  load(formElements) {
    const data = loadFromStorage(CONFIG.STORAGE_KEYS.DATA);
    if (!data) return false;
    formElements.forEach(el => {
      if (el.id && data[el.id] !== undefined) {
        el.type === 'checkbox' ? el.checked = data[el.id] : el.value = data[el.id];
      }
    });
    return true;
  },
  clear() { removeFromStorage(CONFIG.STORAGE_KEYS.DATA); }
};

const ApiKeyManager = {
  save(key) { saveToStorage(CONFIG.STORAGE_KEYS.API_KEY, key); },
  get() { return loadFromStorage(CONFIG.STORAGE_KEYS.API_KEY); },
  clear() { removeFromStorage(CONFIG.STORAGE_KEYS.API_KEY); },
  exists() { return !!this.get(); }
};

const ModelManager = {
  STORAGE_KEY: 'geminiModel',
  save(model) { saveToStorage(this.STORAGE_KEY, model); CONFIG.API.MODEL = model; },
  get() { return loadFromStorage(this.STORAGE_KEY) || CONFIG.API.MODEL; },
  init() { CONFIG.API.MODEL = this.get(); }
};

const BackgroundManager = {
  save(dataUrl) { saveToStorage(CONFIG.STORAGE_KEYS.BACKGROUND, dataUrl); },
  get() { return loadFromStorage(CONFIG.STORAGE_KEYS.BACKGROUND); },
  clear() { removeFromStorage(CONFIG.STORAGE_KEYS.BACKGROUND); },
  apply(element) { const bg = this.get(); if (bg) element.style.backgroundImage = `url(${bg})`; }
};

// ============================================================================
// API
// ============================================================================

// Image state for multimodal parsing
const ImageManager = {
  currentImage: null,  // { base64: string, mimeType: string, fileName: string }

  setImage(base64, mimeType, fileName) {
    this.currentImage = { base64, mimeType, fileName };
  },

  clear() {
    this.currentImage = null;
  },

  hasImage() {
    return this.currentImage !== null;
  },

  getImage() {
    return this.currentImage;
  }
};

async function parseWithAI(inputText, callbacks = {}) {
  const { onStatus, onSuccess, onError } = callbacks;
  const apiKey = ApiKeyManager.get();
  const hasImage = ImageManager.hasImage();
  const hasText = inputText?.trim();

  if (!apiKey) { onStatus?.('Please enter your Gemini API key first.', 'error'); return null; }
  if (!hasText && !hasImage) { onStatus?.('Please enter some notes or upload an image to parse.', 'error'); return null; }

  const url = `${CONFIG.API.BASE_URL}/${CONFIG.API.MODEL}:generateContent?key=${apiKey}`;

  // Build parts array for multimodal request
  const parts = [];

  // Add text prompt
  const textContent = hasText ? inputText : '(See attached image for clinical notes)';
  parts.push({ text: AI_PROMPT_TEMPLATE.replace('{{CLINICAL_NOTES}}', textContent) });

  // Add image if present (Gemini multimodal format)
  if (hasImage) {
    const img = ImageManager.getImage();
    parts.push({
      inlineData: {
        mimeType: img.mimeType,
        data: img.base64
      }
    });
  }

  const body = {
    contents: [{ parts }],
    generationConfig: { temperature: CONFIG.API.TEMPERATURE, maxOutputTokens: CONFIG.API.MAX_OUTPUT_TOKENS }
  };

  let lastError = null;
  for (let attempt = 0; attempt < CONFIG.RETRY.MAX_ATTEMPTS; attempt++) {
    try {
      const statusMsg = hasImage
        ? (attempt === 0 ? 'Parsing image and notes with AI... This may take a few seconds.' : `Retrying... (attempt ${attempt + 1}/${CONFIG.RETRY.MAX_ATTEMPTS})`)
        : (attempt === 0 ? 'Parsing with AI... This may take a few seconds.' : `Retrying... (attempt ${attempt + 1}/${CONFIG.RETRY.MAX_ATTEMPTS})`);
      onStatus?.(statusMsg, 'loading');

      if (!isOnline()) throw new NetworkError('You appear to be offline.');

      const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });

      if (!response.ok) {
        let errorDetails = null;
        try { errorDetails = await response.json(); } catch (e) {}
        throw new ApiError(errorDetails?.error?.message || `API request failed: ${response.status}`, response.status, errorDetails);
      }

      const data = await response.json();
      console.log('[Gemini Response]', JSON.stringify(data, null, 2));

      // Check for finish reason issues
      const candidate = data?.candidates?.[0];
      const finishReason = candidate?.finishReason;
      if (finishReason && finishReason !== 'STOP') {
        console.warn('[Gemini] Finish reason:', finishReason);
        if (finishReason === 'MAX_TOKENS') {
          console.warn('[Gemini] Response was truncated due to max tokens limit');
        }
      }

      // Handle different response formats (Gemini 2.x vs 3.x)
      // Gemini 3 may have multiple parts (thinking + output) or different structure
      let text = null;
      if (candidate?.content?.parts) {
        const parts = candidate.content.parts;
        console.log('[Gemini] Number of parts:', parts.length);

        // Strategy 1: Find the part that looks most like JSON output
        for (const part of parts) {
          if (part.text) {
            const trimmed = part.text.trim();
            // Check if it starts with JSON or contains json code block
            if (trimmed.startsWith('{') || trimmed.startsWith('```json')) {
              text = part.text;
              console.log('[Gemini] Found JSON-like part');
              break;
            }
          }
        }

        // Strategy 2: If no JSON-like part, look for any part containing { and }
        if (!text) {
          for (const part of parts) {
            if (part.text && part.text.includes('{') && part.text.includes('}')) {
              text = part.text;
              console.log('[Gemini] Found part containing JSON object');
              break;
            }
          }
        }

        // Strategy 3: Fallback to last non-empty text part
        if (!text) {
          for (let i = parts.length - 1; i >= 0; i--) {
            if (parts[i].text && parts[i].text.trim()) {
              text = parts[i].text;
              console.log('[Gemini] Using last text part as fallback');
              break;
            }
          }
        }
      }

      if (!text) {
        console.error('[Gemini] No text found in response. Full response:', data);
        throw new Error('Empty response from AI. The model returned no text content. Try using Gemini 2.0 Flash.');
      }

      const parsed = JSON.parse(extractJsonFromText(text));
      onStatus?.('Successfully parsed and populated form fields!', 'success');
      onSuccess?.(parsed);
      return parsed;

    } catch (error) {
      lastError = error;
      logError(error, { attempt, hasImage });
      if (isRetryableError(error) && attempt < CONFIG.RETRY.MAX_ATTEMPTS - 1) {
        const delay = calculateRetryDelay(attempt, CONFIG.RETRY);
        onStatus?.(`Rate limited. Retrying in ${Math.round(delay / 1000)} seconds...`, 'loading');
        await sleep(delay);
        continue;
      }
      break;
    }
  }
  onStatus?.(getErrorMessage(lastError), 'error');
  onError?.(lastError);
  return null;
}

// ============================================================================
// VOICE RECOGNITION
// ============================================================================
class VoiceRecognitionManager {
  constructor() {
    this.recognition = null;
    this.isRecording = false;
    this.language = CONFIG.VOICE.DEFAULT_LANGUAGE;
    this.callbacks = { onResult: null, onError: null, onStart: null, onEnd: null };
  }

  init() {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) return false;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    this.recognition = new SpeechRecognition();
    this.recognition.continuous = true;
    this.recognition.interimResults = true;
    this.recognition.lang = this.language;

    this.recognition.onresult = (event) => {
      let finalTranscript = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript + ' ';
      }
      if (finalTranscript) this.callbacks.onResult?.(finalTranscript);
    };

    this.recognition.onerror = (event) => {
      this.stop();
      const isChinese = this.language === CONFIG.VOICE.LANGUAGES.CHINESE;
      this.callbacks.onError?.(isChinese ? `Ë™ûÈü≥ÈåØË™§: ${event.error}` : `Voice error: ${event.error}`);
    };

    this.recognition.onend = () => { if (this.isRecording) try { this.recognition.start(); } catch (e) {} };
    return true;
  }

  setCallbacks(callbacks) { this.callbacks = { ...this.callbacks, ...callbacks }; }
  setLanguage(lang) { this.language = lang; if (this.recognition) this.recognition.lang = lang; }
  isChinese() { return this.language === CONFIG.VOICE.LANGUAGES.CHINESE; }

  start() {
    if (!this.recognition && !this.init()) {
      this.callbacks.onError?.(this.isChinese() ? 'Ê≠§ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ëæ®Ë≠ò„ÄÇ' : 'Voice recognition not supported.');
      return false;
    }
    this.recognition.lang = this.language;
    try { this.isRecording = true; this.recognition.start(); return true; } catch (e) { this.isRecording = false; return false; }
  }

  stop() { this.isRecording = false; if (this.recognition) try { this.recognition.stop(); } catch (e) {} }
  toggle() { this.isRecording ? this.stop() : this.start(); return this.isRecording; }
  getIsRecording() { return this.isRecording; }
  getButtonText(recording = this.isRecording) { return recording ? (this.isChinese() ? 'ÂÅúÊ≠¢ÈåÑÈü≥' : 'Stop') : (this.isChinese() ? 'ÈñãÂßãÈåÑÈü≥' : 'Start'); }
  getListeningText() { return this.isChinese() ? 'Ê≠£Âú®ËÅÜËÅΩ...' : 'Listening...'; }
}

const voiceManager = new VoiceRecognitionManager();

// ============================================================================
// UI MANAGERS
// ============================================================================
const StatusManager = {
  element: null,
  init(el) { this.element = el; },
  show(message, type) { if (this.element) { this.element.textContent = message; this.element.className = type; this.element.style.display = 'block'; } },
  hide() { if (this.element) { this.element.className = ''; this.element.style.display = 'none'; } }
};

// Progress bar manager for visual feedback during AI parsing
const ProgressManager = {
  container: null,
  fill: null,
  text: null,
  intervalId: null,
  currentProgress: 0,

  init() {
    this.container = document.getElementById('aiProgressContainer');
    this.fill = document.getElementById('aiProgressFill');
    this.text = document.getElementById('aiProgressText');
  },

  start() {
    if (!this.container) this.init();
    this.currentProgress = 0;
    this.fill.style.width = '0%';
    this.container.style.display = 'block';
    this.text.textContent = 'Sending to AI...';

    // Animate progress: fast at start, slower as it approaches 90%
    let speed = 2;
    this.intervalId = setInterval(() => {
      if (this.currentProgress < 30) {
        speed = 3;
        this.text.textContent = 'Sending to AI...';
      } else if (this.currentProgress < 60) {
        speed = 1.5;
        this.text.textContent = 'AI is processing...';
      } else if (this.currentProgress < 85) {
        speed = 0.5;
        this.text.textContent = 'Parsing response...';
      } else {
        speed = 0.1;
        this.text.textContent = 'Almost done...';
      }
      this.currentProgress = Math.min(90, this.currentProgress + speed);
      this.fill.style.width = this.currentProgress + '%';
    }, 100);
  },

  complete() {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
    this.currentProgress = 100;
    this.fill.style.width = '100%';
    this.text.textContent = 'Done!';
    setTimeout(() => this.hide(), 1500);
  },

  error(message) {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
    this.fill.style.background = '#dc3545';
    this.text.textContent = message || 'Error occurred';
    setTimeout(() => {
      this.hide();
      this.fill.style.background = 'linear-gradient(90deg, #4285f4, #34a853)';
    }, 3000);
  },

  hide() {
    if (this.container) {
      this.container.style.display = 'none';
      this.fill.style.width = '0%';
      this.currentProgress = 0;
    }
  }
};

const ToastManager = {
  element: null,
  init(el) { this.element = el; },
  show(message, duration = CONFIG.UI.TOAST_DURATION_MS) { if (this.element) { this.element.textContent = message; this.element.classList.add('show'); setTimeout(() => this.element.classList.remove('show'), duration); } }
};

async function copyToClipboard(text) {
  try {
    if (navigator.clipboard) { await navigator.clipboard.writeText(text); return true; }
    const ta = document.createElement('textarea'); ta.value = text; ta.style.position = 'fixed'; ta.style.left = '-9999px';
    document.body.appendChild(ta); ta.select(); const success = document.execCommand('copy'); document.body.removeChild(ta); return success;
  } catch (e) { return false; }
}

// ============================================================================
// NOTE GENERATOR
// ============================================================================
function addSectionToOutput(title, content, container) {
  if (!content || content.trim() === '' || content.trim() === 'N/A') return;
  const sectionDiv = document.createElement('div');
  sectionDiv.className = 'output-section';
  sectionDiv.innerHTML = `<h3>${title}<button class="copy-section-btn" title="Copy">üìã</button></h3><div class="output-content">${sanitizeHTML(content)}</div>`;
  container.appendChild(sectionDiv);
}

function compileROS() {
  let rosOutput = 'Á≥ªÁµ±ÊÄßÂõûÈ°ß(Review of Systems)\n(‚ñ†: positive, ‚ñ°:negative)';
  const rosDetails = getVal('ros_details', '');
  if (rosDetails) rosOutput += `\n${rosDetails}\n`;
  document.querySelectorAll('#rosSection details').forEach(det => {
    const sysTitle = det.querySelector('summary').textContent.trim();
    const items = det.querySelectorAll('input[type="checkbox"]');
    const parts = Array.from(items).map(cb => `${plusMinus(cb.id)} ${cb.parentElement.textContent.trim()}`);
    rosOutput += `\n- ${sysTitle}:\n    ${parts.join(', ')}`;
  });
  return rosOutput.trim();
}

function assembleHistoryBlock() {
  const medAllergyDenied = document.getElementById('hist_med_allergy_denied')?.checked;
  let medAllergyStr = medAllergyDenied ? 'No known' : (getVal('hist_med_allergy_details', '') || 'unknown');
  if (!medAllergyDenied && getVal('hist_med_allergy_date', '')) medAllergyStr += ` (${getVal('hist_med_allergy_date', '')})`;

  const deviceAllergyDenied = document.getElementById('hist_device_allergy_denied')?.checked;
  let deviceAllergyStr = deviceAllergyDenied ? 'No known' : (getVal('hist_device_allergy_details', '') || 'unknown');

  const fhArr = [`HTN ${plusMinus('fh_HTN')}`, `DM ${plusMinus('fh_DM')}`, `DLP ${plusMinus('fh_DLP')}`, `Cancer ${plusMinus('fh_CA')}`, `CAD ${plusMinus('fh_CAD')}`];
  let fhStr = fhArr.join(', ');
  if (getVal('fh_details', '')) fhStr += `\n${getVal('fh_details', '')}`;

  return [
    `ÁóÖÂè≤(Patient History)\n${getVal('patientHistoryNarrative', 'Not specified')}`,
    `[Past medical history]\n${getVal('hist_pmh', 'Not specified')}`,
    `[Past surgical history]\n${getVal('hist_surgical_history_detailed', 'denied')}`,
    `[Hospitalization]\n${getVal('hist_hospitalization_history', 'denied')}`,
    `Current Medication:\nÂè∞Â§ßÈÜ´Èô¢: ${getVal('hist_current_med_ntuh', 'nil')}\nOther: ${getVal('hist_current_med_other', 'denied')}\n‰∏≠ËçâËó•: ${getVal('hist_current_med_tcm', 'denied')}\n‰øùÂÅ•È£üÂìÅ: ${getVal('hist_current_med_supplements', 'denied')}`,
    `Allergy:\n- Medication Allergy: ${medAllergyStr}\n- Medication ADR: ${getVal('hist_med_adr', 'unknown')}\n- Device/Material Allergy: ${deviceAllergyStr}`,
    `Family History:\n${fhStr}`,
    `TOCC:\n- Travel: ${getVal('hist_tocc_travel', 'denied')}\n- Occupation: ${getVal('hist_tocc_occupation', 'N/A')}\n- Cluster/Contact: ${getVal('hist_tocc_cluster', 'denied')}`,
    `Social History:\n- Alcohol: ${getVal('hist_abc_alcohol', 'denied')}\n- Betel: ${getVal('hist_abc_betel', 'denied')}\n- Smoking: ${getVal('hist_abc_smoking', 'denied')}`
  ].join('\n\n');
}

function generateNotePreview(outputEl) {
  outputEl.innerHTML = '';
  addSectionToOutput('‰∏ªË®¥(Chief Complaint)', `Informant: ${getVal('informant', 'patient and EMR')}\n${getVal('ccpi', 'Not specified')}`, outputEl);
  addSectionToOutput('ÁóÖÂè≤(Patient History)', assembleHistoryBlock(), outputEl);
  addSectionToOutput('Á§æÊúÉÂøÉÁêÜÁõ∏ÈóúË©ï‰º∞(Psychosocial Assessment)', getVal('psychosocial_assessment', 'pending'), outputEl);
  addSectionToOutput('Á≥ªÁµ±ÊÄßÂõûÈ°ß(Review of Systems)', compileROS(), outputEl);

  let peText = `BH: ${getVal('vitals_bh', '--')} cm, BW: ${getVal('vitals_bw', '--')} kg\nT: ${getVal('vitals_t', '--')}¬∞C, P: ${getVal('vitals_p', '--')} bpm, R: ${getVal('vitals_r', '--')}/min\nBP: ${getVal('vitals_bp', '--/--')} mmHg, Pain: ${getVal('vitals_pain', '0')}\n\n`;
  if (getVal('pe_details', '')) peText += getVal('pe_details', '') + '\n\n';
  peText += `[Neurological]\n- Consciousness: ${getVal('pe_neuro_conscious', 'E4V5M6')}\n- Muscle power: ${getVal('pe_neuro_power', 'intact')}\n- Gait: ${getVal('pe_neuro_gait', 'steady')}`;
  addSectionToOutput('Ë∫´È´îË®∫ÂØü(Physical Examination)', peText, outputEl);

  addSectionToOutput('ÂΩ±ÂÉèÂ†±Âëä(Imaging Report)', getVal('imaging_report', 'nil'), outputEl);
  addSectionToOutput('ÁóÖÁêÜÂ†±Âëä(Pathology Report)', getVal('pathology_report', 'nil'), outputEl);
  addSectionToOutput('ËáÜÊñ∑(Tentative Diagnosis)', `[Active]\n${getVal('diagnosis_active', 'Not specified')}\n\n[Underlying]\n${getVal('diagnosis_underlying', 'Not specified')}`, outputEl);

  const soapContent = `${getVal('plan_age_sex', '*--')}\n\nS:\n- ${getVal('ccpi', 'Not specified')}\n\nO:\n[General]\n- Consciousness: ${getVal('pe_neuro_conscious', 'E4V5M6')}\n\n[PE]\n${getVal('plan_pe_findings', 'See PE section')}\n\n[lab]\n${getVal('plan_lab_data', '- pending')}\n\n[image]\n- CXR ${getVal('plan_cxr_date', '')}: ${getVal('plan_cxr_interp', '(-)')}\n- ECG ${getVal('plan_ekg_date', '')}: ${getVal('plan_ekg_interp', 'NSR')}\n\nA:\n[Active]\n${getVal('plan_assessment_active', getVal('diagnosis_active', 'Not specified'))}\n\n[Underlying]\n${getVal('plan_assessment_underlying', getVal('diagnosis_underlying', 'Not specified'))}\n\nP:\n${getVal('plan_plan', '- symptomatic treatment')}\n\nTreatment goal:\n- ${getVal('plan_treatment_goal', 'clinical stability')}`;
  addSectionToOutput('ÈÜ´ÁôÇÈúÄÊ±ÇËàáÊ≤ªÁôÇË®àÁï´(Medical Needs and Care Plan)', soapContent, outputEl);

  addSectionToOutput('Âá∫Èô¢Ë¶èÂäÉ(Discharge Planning)', `ÁÆ°Ë∑ØÁïôÁΩÆÁãÄÊ≥ÅÔºö${getVal('dp_catheter', 'Nil')}\nÊó•Â∏∏ÁîüÊ¥ªÂäüËÉΩÂàÜÊï∏Ôºö${getVal('dp_adl', '100')}\nÈ†êÊúüÂá∫Èô¢ÂæåÂ±Ö‰ΩèÂ†¥ÊâÄÔºö${getVal('dp_residence', 'ËàáÂÆ∂‰∫∫Âêå‰Ωè')}\nÈ†êÊúüÂá∫Èô¢Âæå‰∏ªË¶ÅÁÖßÈ°ßËÄÖÔºö${getVal('dp_caregiver', 'Ëá™Â∑±')}\nÂá∫Èô¢Ë¶èÂäÉÊî∂Ê°àÁØ©Ê™¢Ôºö${getVal('dp_screening', '‰∏ÄËà¨ÁóÖÊÇ£')}`, outputEl);
}

// ============================================================================
// FORM POPULATOR
// ============================================================================
function populateForm(data) {
  if (!data) return;
  const setField = (id, value) => { if (value == null) return; const el = document.getElementById(id); if (el) { el.value = value; el.classList.add('ai-populated'); el.dispatchEvent(new Event('input', { bubbles: true })); } };
  const setCheckbox = (id, checked) => { if (checked == null) return; const el = document.getElementById(id); if (el) { el.checked = checked; el.dispatchEvent(new Event('change', { bubbles: true })); } };

  if (data.chief_complaint) setField('ccpi', data.chief_complaint);
  if (data.age_sex) setField('plan_age_sex', data.age_sex);
  if (data.patient_narrative) setField('patientHistoryNarrative', data.patient_narrative);
  if (data.past_medical_history) setField('hist_pmh', data.past_medical_history);
  if (data.past_surgical_history) setField('hist_surgical_history_detailed', data.past_surgical_history);
  if (data.medication_allergy?.denied) setCheckbox('hist_med_allergy_denied', true);
  else if (data.medication_allergy?.details) setField('hist_med_allergy_details', data.medication_allergy.details);
  if (data.current_medications) setField('hist_current_med_other', data.current_medications);
  if (data.family_history) {
    setCheckbox('fh_HTN', data.family_history.HTN); setCheckbox('fh_DM', data.family_history.DM);
    setCheckbox('fh_DLP', data.family_history.DLP); setCheckbox('fh_CA', data.family_history.Cancer);
    setCheckbox('fh_CAD', data.family_history.CAD); if (data.family_history.details) setField('fh_details', data.family_history.details);
  }
  if (data.social_history) {
    if (data.social_history.alcohol) setField('hist_abc_alcohol', data.social_history.alcohol);
    if (data.social_history.smoking) setField('hist_abc_smoking', data.social_history.smoking);
    if (data.social_history.betel) setField('hist_abc_betel', data.social_history.betel);
  }
  if (data.vitals) {
    if (data.vitals.temperature) setField('vitals_t', data.vitals.temperature);
    if (data.vitals.pulse) setField('vitals_p', data.vitals.pulse);
    if (data.vitals.respiration) setField('vitals_r', data.vitals.respiration);
    if (data.vitals.bp) setField('vitals_bp', data.vitals.bp);
    if (data.vitals.height) setField('vitals_bh', data.vitals.height);
    if (data.vitals.weight) setField('vitals_bw', data.vitals.weight);
  }
  if (data.physical_exam) {
    const pe = [];
    if (data.physical_exam.general) pe.push(`General: ${data.physical_exam.general}`);
    if (data.physical_exam.chest) pe.push(`Chest: ${data.physical_exam.chest}`);
    if (data.physical_exam.heart) pe.push(`Heart: ${data.physical_exam.heart}`);
    if (data.physical_exam.abdomen) pe.push(`Abdomen: ${data.physical_exam.abdomen}`);
    if (data.physical_exam.extremities) pe.push(`Extremities: ${data.physical_exam.extremities}`);
    if (pe.length > 0) setField('pe_details', pe.join('\n'));
    if (data.physical_exam.consciousness) setField('pe_neuro_conscious', data.physical_exam.consciousness);
  }
  if (data.tocc) {
    if (data.tocc.travel) setField('hist_tocc_travel', data.tocc.travel);
    if (data.tocc.occupation) setField('hist_tocc_occupation', data.tocc.occupation);
    if (data.tocc.cluster) setField('hist_tocc_cluster', data.tocc.cluster);
  }
  if (data.diagnosis_active) setField('diagnosis_active', data.diagnosis_active.replace(/\[Active\]\n?/g, ''));
  if (data.diagnosis_underlying) setField('diagnosis_underlying', data.diagnosis_underlying.replace(/\[Underlying\]\n?/g, ''));
  if (data.soap_o_lab) setField('plan_lab_data', data.soap_o_lab.replace(/\[lab\]\n?/g, ''));
  if (data.soap_a_active) setField('plan_assessment_active', data.soap_a_active.replace(/\[Active\]\n?/g, ''));
  if (data.soap_a_underlying) setField('plan_assessment_underlying', data.soap_a_underlying.replace(/\[Underlying\]\n?/g, ''));
  if (data.soap_plan) setField('plan_plan', data.soap_plan);
  if (data.treatment_goal) setField('plan_treatment_goal', data.treatment_goal.replace(/^- /, ''));
}

// ============================================================================
// MAIN APPLICATION
// ============================================================================
document.addEventListener('DOMContentLoaded', () => {
  const sectionsContainer = document.getElementById('sectionsContainer');
  const blockContainer = document.getElementById('blockContainer');
  const allFormElements = Array.from(sectionsContainer.querySelectorAll('input, textarea'));
  const allSections = Array.from(sectionsContainer.querySelectorAll('section'));
  const blocks = {};

  const modalOverlay = document.getElementById('modalOverlay');
  const modalBody = document.getElementById('modalBody');
  const modalClose = document.getElementById('modalClose');
  const noteOutputEl = document.getElementById('noteOutput');

  StatusManager.init(document.getElementById('aiStatus'));
  ToastManager.init(document.getElementById('copy-toast'));

  // Build blocks
  allSections.forEach(section => {
    const block = document.createElement('div');
    block.className = 'block';
    block.dataset.sectionId = section.id;
    block.innerHTML = `<h2>${section.dataset.title || 'Section'}</h2>`;
    blockContainer.appendChild(block);
    blocks[section.id] = block;
  });

  // UI State
  function isSectionFilled(section) {
    for (const input of section.querySelectorAll('input[type="text"], textarea')) if (input.value.trim()) return true;
    for (const cb of section.querySelectorAll('input[type="checkbox"]')) if (cb.checked) return true;
    return false;
  }

  function updateUIState() {
    let allFilled = true;
    allSections.forEach(section => {
      const filled = isSectionFilled(section);
      blocks[section.id].classList.toggle('completed', filled);
      if (!filled) allFilled = false;
    });
    document.getElementById('copyFullNoteBtn').classList.toggle('ready', allFilled);
    generateNotePreview(noteOutputEl);
  }

  const debouncedSave = debounce(() => { FormDataManager.save(allFormElements); updateUIState(); }, CONFIG.UI.DEBOUNCE_DELAY_MS);

  // Modal
  function openModal(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) { modalBody.appendChild(section); modalOverlay.style.display = 'flex'; requestAnimationFrame(() => modalOverlay.classList.add('active')); }
  }

  function closeModal() {
    modalOverlay.classList.remove('active');
    setTimeout(() => { modalOverlay.style.display = 'none'; const s = modalBody.querySelector('section'); if (s) { sectionsContainer.appendChild(s); debouncedSave(); } }, CONFIG.UI.MODAL_ANIMATION_MS);
  }

  blockContainer.addEventListener('click', e => { const b = e.target.closest('.block'); if (b) openModal(b.dataset.sectionId); });
  modalClose.addEventListener('click', closeModal);
  modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) closeModal(); });

  // API Key
  const apiKeySetup = document.getElementById('apiKeySetup');
  const parseBtn = document.getElementById('parseBtn');

  function checkApiKey() {
    if (ApiKeyManager.exists()) { apiKeySetup.style.display = 'none'; parseBtn.disabled = false; return true; }
    parseBtn.disabled = true; return false;
  }

  document.getElementById('saveApiKey').addEventListener('click', () => {
    const key = document.getElementById('apiKeyInput').value.trim();
    if (key) { ApiKeyManager.save(key); document.getElementById('apiKeyStatus').textContent = ' ‚úì Saved!'; setTimeout(() => { apiKeySetup.style.display = 'none'; parseBtn.disabled = false; }, 1000); }
  });

  document.getElementById('clear-api-key').addEventListener('click', () => {
    ApiKeyManager.clear(); apiKeySetup.style.display = 'block'; document.getElementById('apiKeyInput').value = '';
    document.getElementById('apiKeyStatus').textContent = ''; parseBtn.disabled = true;
    document.getElementById('settings-menu').style.display = 'none';
  });

  // AI Parsing
  parseBtn.addEventListener('click', async () => {
    parseBtn.disabled = true;
    ProgressManager.start();
    await parseWithAI(document.getElementById('aiInputArea').value.trim(), {
      onStatus: (msg, type) => StatusManager.show(msg, type),
      onSuccess: (data) => {
        ProgressManager.complete();
        populateForm(data);
        debouncedSave();
        setTimeout(() => StatusManager.hide(), CONFIG.UI.STATUS_HIDE_DELAY_MS);
      },
      onError: (error) => {
        ProgressManager.error(getErrorMessage(error));
      }
    });
    parseBtn.disabled = !ApiKeyManager.exists();
  });

  document.getElementById('clearAiBtn').addEventListener('click', () => {
    document.getElementById('aiInputArea').value = '';
    clearUploadedImage();
    StatusManager.hide();
  });

  // Image Upload Handling
  const imageInput = document.getElementById('imageInput');
  const imageFileName = document.getElementById('imageFileName');
  const clearImageBtn = document.getElementById('clearImageBtn');
  const imagePreview = document.getElementById('imagePreview');
  const previewImg = document.getElementById('previewImg');

  function clearUploadedImage() {
    ImageManager.clear();
    imageInput.value = '';
    imageFileName.textContent = '';
    clearImageBtn.style.display = 'none';
    imagePreview.style.display = 'none';
    previewImg.src = '';
  }

  imageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Validate file type
    if (!file.type.startsWith('image/')) {
      StatusManager.show('Please select an image file.', 'error');
      return;
    }

    // Validate file size (max 10MB for Gemini)
    if (file.size > 10 * 1024 * 1024) {
      StatusManager.show('Image too large. Please use an image under 10MB.', 'error');
      return;
    }

    const reader = new FileReader();
    reader.onload = (event) => {
      const dataUrl = event.target.result;
      // Extract base64 data (remove data:image/xxx;base64, prefix)
      const base64Data = dataUrl.split(',')[1];
      const mimeType = file.type;

      ImageManager.setImage(base64Data, mimeType, file.name);

      // Update UI
      imageFileName.textContent = file.name;
      clearImageBtn.style.display = 'inline-flex';
      previewImg.src = dataUrl;
      imagePreview.style.display = 'block';

      StatusManager.show('Image uploaded. Click "Parse with AI" to process.', 'success');
      setTimeout(() => StatusManager.hide(), 2000);
    };

    reader.onerror = () => {
      StatusManager.show('Failed to read image file.', 'error');
    };

    reader.readAsDataURL(file);
  });

  clearImageBtn.addEventListener('click', clearUploadedImage);

  // Voice
  const voiceBtn = document.getElementById('voiceBtn');
  const voiceIcon = document.getElementById('voiceIcon');
  const voiceText = document.getElementById('voiceText');
  const voiceLang = document.getElementById('voiceLang');

  function updateVoiceUI(recording) {
    voiceBtn.classList.toggle('recording', recording);
    voiceIcon.textContent = recording ? '‚èπÔ∏è' : 'üé§';
    voiceText.textContent = voiceManager.getButtonText(recording);
  }

  voiceLang.addEventListener('change', () => { voiceManager.setLanguage(voiceLang.value); updateVoiceUI(voiceManager.getIsRecording()); });
  voiceManager.setCallbacks({
    onResult: (t) => { document.getElementById('aiInputArea').value += t; },
    onError: (msg) => { StatusManager.show(msg, 'error'); updateVoiceUI(false); },
    onStart: () => StatusManager.show(voiceManager.getListeningText(), 'loading'),
    onEnd: () => StatusManager.hide()
  });

  voiceBtn.addEventListener('click', () => { const r = voiceManager.toggle(); updateVoiceUI(r); if (!r) StatusManager.hide(); });

  // Copy buttons
  document.getElementById('copyFullNoteBtn').addEventListener('click', async () => { if (await copyToClipboard(noteOutputEl.innerText)) ToastManager.show('Full Note Copied!'); });
  document.getElementById('copyHistoryBtn').addEventListener('click', async () => { if (await copyToClipboard(assembleHistoryBlock())) ToastManager.show('History Block Copied!'); });
  document.getElementById('noteOutputContainer').addEventListener('click', async e => {
    const btn = e.target.closest('.copy-section-btn');
    if (btn) { const content = btn.closest('.output-section').querySelector('.output-content').innerText; if (await copyToClipboard(content)) { btn.textContent = '‚úîÔ∏è'; setTimeout(() => btn.textContent = 'üìã', 1500); } }
  });

  // Settings
  const settingsGear = document.getElementById('settings-gear');
  const settingsMenu = document.getElementById('settings-menu');
  const settingsContainer = document.getElementById('settings-container');
  settingsGear.addEventListener('click', () => { settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block'; });
  document.addEventListener('click', e => { if (!settingsContainer.contains(e.target) && settingsMenu.style.display === 'block') settingsMenu.style.display = 'none'; });

  document.getElementById('clear-data').addEventListener('click', () => { if (confirm('Clear all data for new patient?')) { FormDataManager.clear(); location.reload(); } });

  document.getElementById('background-input').addEventListener('change', e => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => { document.body.style.backgroundImage = `url(${ev.target.result})`; BackgroundManager.save(ev.target.result); };
    reader.readAsDataURL(file);
  });

  document.getElementById('reset-background').addEventListener('click', () => { document.body.style.backgroundImage = ''; BackgroundManager.clear(); });

  // Auto-save
  sectionsContainer.addEventListener('input', debouncedSave);

  // Model Selector
  const modelSelect = document.getElementById('modelSelect');
  ModelManager.init();
  modelSelect.value = ModelManager.get();
  modelSelect.addEventListener('change', () => {
    ModelManager.save(modelSelect.value);
    console.log('[Model changed]', modelSelect.value);
  });

  // Initialize
  FormDataManager.load(allFormElements);
  BackgroundManager.apply(document.body);
  checkApiKey();
  updateUIState();

  console.log('Admission Note Builder initialized with model:', CONFIG.API.MODEL);
});
  </script>
</body>
</html>
