<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admission Note Builder - AI Enhanced</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent: #007bff;
      --accent-dark: #0056b3;
      --danger: #dc3545;
      --danger-dark: #b02a37;
      --border: #e0e6ed;
      --radius: 10px;
      --bg-start: #f8f9fa;
      --bg-end: #e9ecef;
      --card: #ffffff;
      --text-color: #212529;
      --header-color: #212529;
      --shadow: 0 4px 12px rgba(0, 0, 0, .07);
      --complete-green: #74B72E;
      --ready-purple: #6f42c1;
      --toast-bg: #28a745;
      --ai-accent: #10a37f;
      --ai-accent-dark: #0d8a6a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', "Segoe UI", Arial, sans-serif;
      background-image: linear-gradient(to bottom, var(--bg-start), var(--bg-end));
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh;
      color: var(--text-color);
      line-height: 1.6;
      padding: 24px;
    }
    h1 { text-align: center; margin: 0 0 16px; color: var(--header-color); font-size: 2.2rem; font-weight: 700; }
    h2 { margin: 0 0 16px; font-size: 1.5rem; color: var(--header-color); border-bottom: 1px solid var(--border); padding-bottom: 8px; font-weight: 600; }
    h3 { margin: 18px 0 10px; font-size: 1.1rem; color: var(--header-color); font-weight: 600; }
    h4 { margin: 16px 0 8px; font-size: 1rem; color: var(--header-color); font-weight: 600; }

    /* AI Quick Entry Panel */
    #aiPanel {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border: 2px solid var(--ai-accent);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    #aiPanel h2 {
      color: var(--ai-accent-dark);
      border-bottom-color: var(--ai-accent);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #aiPanel h2::before {
      content: "âœ¨";
    }
    #aiInputArea {
      width: 100%;
      min-height: 150px;
      border: 1px solid var(--ai-accent);
      border-radius: var(--radius);
      padding: 12px;
      font-family: inherit;
      font-size: 1rem;
      resize: vertical;
      margin-bottom: 12px;
    }
    #aiInputArea:focus {
      outline: none;
      border-color: var(--ai-accent-dark);
      box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.25);
    }
    .ai-button-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .ai-btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #parseBtn {
      background-color: var(--ai-accent);
      color: white;
    }
    #parseBtn:hover:not(:disabled) {
      background-color: var(--ai-accent-dark);
      transform: translateY(-2px);
    }
    #parseBtn:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }
    #voiceBtn {
      background-color: #ef4444;
      color: white;
    }
    #voiceBtn:hover:not(:disabled) {
      background-color: #dc2626;
    }
    #voiceBtn.recording {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    }
    #clearAiBtn {
      background-color: #6b7280;
      color: white;
    }
    #clearAiBtn:hover {
      background-color: #4b5563;
    }
    /* Language Toggle */
    .lang-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 12px;
      font-size: 0.9rem;
    }
    .lang-toggle select {
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 4px 8px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    #aiStatus {
      margin-top: 12px;
      padding: 10px;
      border-radius: var(--radius);
      display: none;
    }
    #aiStatus.loading {
      display: block;
      background-color: #fef3c7;
      color: #92400e;
    }
    #aiStatus.success {
      display: block;
      background-color: #d1fae5;
      color: #065f46;
    }
    #aiStatus.error {
      display: block;
      background-color: #fee2e2;
      color: #991b1b;
    }

    /* API Key Setup */
    #apiKeySetup {
      background: #fff7ed;
      border: 1px solid #fb923c;
      border-radius: var(--radius);
      padding: 15px;
      margin-bottom: 15px;
    }
    #apiKeySetup input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-top: 8px;
      font-family: monospace;
    }
    #apiKeySetup button {
      margin-top: 10px;
      padding: 8px 16px;
      background: #fb923c;
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
    }
    #apiKeySetup button:hover {
      background: #ea580c;
    }
    .api-key-saved {
      color: var(--complete-green);
      font-weight: 500;
    }

    /* Block Layout */
    #blockContainer { display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; padding: 20px 0; }
    .block {
        background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px;
        text-align: center; flex-basis: 220px; flex-grow: 1; cursor: pointer; transition: all .2s ease;
        box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; min-height: 100px;
    }
    .block:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0, 0, 0, .09); }
    .block h2 { border-bottom: none; padding: 0; margin: 0; font-size: 1.2rem; font-weight: 500; }
    .block.completed { background-color: var(--complete-green); color: white; border-color: #66a529; transform: translateY(-2px); }
    .block.ai-filled { background-color: var(--ai-accent); color: white; border-color: var(--ai-accent-dark); }

    /* Settings Menu */
    #settings-container { position: fixed; top: 15px; right: 15px; z-index: 999; }
    #settings-gear { font-size: 1.8rem; font-weight: bold; line-height: 1; cursor: pointer; background: var(--card); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow); user-select: none; }
    #settings-menu { display: none; position: absolute; right: 0; top: 50px; background: var(--card); border-radius: var(--radius); box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 15px; width: 250px; }
    #settings-menu button { width: 100%; padding: 8px 12px; margin-top: 10px; border-radius: var(--radius); border: 1px solid var(--border); cursor: pointer; background-color: #f8f9fa; }
    #settings-menu button:hover { background-color: #e9ecef; }
    #settings-menu #clear-data { background-color: var(--danger); color: white; border-color: var(--danger); }
    #settings-menu #clear-data:hover { background-color: var(--danger-dark); }
    #settings-menu #clear-api-key { background-color: #fb923c; color: white; border-color: #fb923c; }
    #settings-menu input[type="file"] { display: none; }

    /* Modal Styles */
    #modalOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity .2s ease-in-out; }
    #modalOverlay.active { display: flex; opacity: 1; }
    #modalContent { background: var(--bg-end); padding: 0; border-radius: var(--radius); width: 90%; max-width: 850px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; position: relative; transform: translateY(20px); transition: transform .3s cubic-bezier(0.25, 1, 0.5, 1); }
    #modalOverlay.active #modalContent { transform: translateY(0); }
    #modalClose { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 2rem; color: #888; cursor: pointer; line-height: 1; z-index: 1010; }
    #modalClose:hover { color: #333; }
    #modalBody { overflow-y: auto; padding: 20px 30px; }
    #modalBody section { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 24px; padding: 20px 24px; box-shadow: var(--shadow); }
    #sectionsContainer { display: none; }

    /* Controls and Output Area */
    #controls { padding: 20px; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); margin-top: 20px; }
    #controls .button-group { display: flex; gap: 15px; margin-bottom: 15px; }
    #controls .button-group button { flex: 1; padding: 12px; font-size: 1.05rem; cursor: pointer; border: none; border-radius: var(--radius); transition: all .2s ease; }
    #copyHistoryBtn { background-color: #ffc107; color: black; }
    #copyHistoryBtn:hover { background-color: #e0a800; }
    #copyFullNoteBtn { background-color: var(--accent); color: white; }
    #copyFullNoteBtn:hover { background-color: var(--accent-dark); }
    #copyFullNoteBtn.ready { background-color: var(--ready-purple); font-weight: bold; transform: scale(1.02); }
    #copyFullNoteBtn.ready:hover { background-color: #5a32a3; }
    #noteOutputContainer { border: 1px solid var(--border); border-radius: var(--radius); background: #f4f6f8; padding: 15px 20px; min-height: 400px; max-height: 50vh; overflow-y: auto; }
    #noteOutput { font-family: 'Consolas', 'Monaco', monospace; white-space: pre-wrap; word-wrap: break-word; font-size: 0.9rem; color: #333; }
    .output-section { margin-bottom: 1.5em; }
    .output-section h3 { font-family: 'Inter', sans-serif; font-size: 1.1rem; font-weight: 600; color: #000; margin: 0 0 0.5em 0; display: flex; align-items: center; justify-content: space-between; }
    .copy-section-btn { background: #d1d5db; border: none; border-radius: 5px; cursor: pointer; padding: 4px 8px; font-size: 0.8rem; opacity: 0.7; transition: all .2s; }
    .copy-section-btn:hover { background-color: #b9bec5; opacity: 1; }
    .output-content { padding-left: 5px; }

    /* Toast Notification */
    #copy-toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: var(--toast-bg); color: white; padding: 12px 24px; border-radius: var(--radius); box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 2000; transition: bottom 0.5s cubic-bezier(0.25, 1, 0.5, 1); font-weight: 500; }
    #copy-toast.show { bottom: 30px; }

    /* General Form Styles */
    textarea, input[type="text"] { width: 100%; border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 12px; font-family: inherit; font-size: 1rem; resize: vertical; transition: border-color .2s, box-shadow .2s; background: #fdfdfd; }
    textarea:focus, input[type="text"]:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
    details { margin-top: 10px; border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 15px; background: #fdfefe; }
    details summary { cursor: pointer; font-weight: 600; color: var(--header-color); list-style: none; display: flex; align-items: center; }
    details summary::before { content: 'â–º'; margin-right: 10px; transition: transform 0.2s; font-size: 0.8em; }
    details[open] summary::before { transform: rotate(90deg); }
    details > div { padding-top: 10px; border-top: 1px dashed var(--border); margin-top: 10px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px 16px; margin-top: 8px; }
    .vitals-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px 16px; }
    label.toggle { display: flex; align-items: center; gap: 8px; font-size: .95rem; user-select: none; cursor: pointer; }
    label.toggle input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent); flex-shrink: 0; }

    /* AI-filled field highlight */
    .ai-populated {
      background-color: #f0fdf4 !important;
      border-color: var(--ai-accent) !important;
    }
  </style>
</head>
<body>
  <div id="settings-container">
    <div id="settings-gear">â‰¡</div>
    <div id="settings-menu">
      <h4>Settings</h4>
      <input type="file" id="background-input" accept="image/*" />
      <button onclick="document.getElementById('background-input').click();">Change Background</button>
      <button id="reset-background">Reset Background</button>
      <button id="clear-api-key">Reset API Key</button>
      <button id="clear-data">Clear for New Patient</button>
    </div>
  </div>

  <h1>Admission Note Builder - AI Enhanced</h1>
  <p style="text-align:center; max-width: 700px; margin: 0 auto 20px;">Paste or dictate your notes, and AI will structure them into the admission form. Review, edit, and copy to EMR.</p>

  <!-- AI Quick Entry Panel -->
  <div id="aiPanel">
    <h2>AI Quick Entry</h2>

    <div id="apiKeySetup">
      <label><strong>Gemini API Key</strong> (stored locally in your browser)</label>
      <input type="password" id="apiKeyInput" placeholder="Enter your Gemini API key..." />
      <button id="saveApiKey">Save Key</button>
      <span id="apiKeyStatus"></span>
    </div>

    <textarea id="aiInputArea" placeholder="Paste your notes here, or click the microphone to dictate...

Example:
65 year old male with history of HTN, DM, presenting with chest pain for 2 hours. Pain is substernal, pressure-like, radiating to left arm. Associated with diaphoresis and shortness of breath. No similar episodes before. Denies fever, cough, abdominal pain.

On exam: alert, diaphoretic. BP 160/95, HR 88, T 36.5, RR 18. Heart regular, no murmur. Lungs clear. Abdomen soft. No leg edema.

PMH: HTN x 10 years on amlodipine, DM on metformin. No surgeries. NKDA. Father had MI at age 60. Non-smoker, occasional alcohol."></textarea>

    <div class="ai-button-row">
      <div class="lang-toggle">
        <span>ğŸŒ</span>
        <select id="voiceLang">
          <option value="zh-TW">ä¸­æ–‡</option>
          <option value="en-US">English</option>
        </select>
      </div>
      <button id="voiceBtn" class="ai-btn">
        <span id="voiceIcon">ğŸ¤</span>
        <span id="voiceText">é–‹å§‹éŒ„éŸ³</span>
      </button>
      <button id="parseBtn" class="ai-btn" disabled>
        <span>ğŸ¤–</span>
        <span>Parse with AI</span>
      </button>
      <button id="clearAiBtn" class="ai-btn">
        <span>ğŸ—‘ï¸</span>
        <span>Clear</span>
      </button>
    </div>

    <div id="aiStatus"></div>
  </div>

  <div id="blockContainer"></div>
  <div id="modalOverlay">
    <div id="modalContent">
      <button id="modalClose">Ã—</button>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- This is the original, complete section container -->
  <div id="sectionsContainer">
    <section id="chiefSection" data-title="Chief Complaint"><h2>Chief Complaint & Present Illness</h2><label>Informant: <input type="text" id="informant" placeholder="Patient and medical records"/></label><textarea id="ccpi" rows="5" placeholder="e.g., Symptoms for a length of time..."></textarea></section>
    <section id="historySection" data-title="History"><h2>Routine History</h2><h3>Patient History & Present Illness Narrative</h3><textarea id="patientHistoryNarrative" rows="12" placeholder="e.g., This is a xx-year-old (wo)man with..."></textarea><h3>Past Medical History (Structured)</h3><textarea id="hist_pmh" rows="4" placeholder="1. Some kind of disease...
2. Some other kind of disease"></textarea><h3>Medication Allergy</h3><div style="margin-top:6px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px;"><label class="toggle" style="flex-shrink: 0;"><input type="checkbox" id="hist_med_allergy_denied"/>Denied</label><input type="text" id="hist_med_allergy_details" placeholder="Details (e.g., Penicillin, Rash)" style="flex-grow: 1; min-width: 150px;"/><label style="flex-shrink: 0;">Date: <input type="text" id="hist_med_allergy_date" placeholder="YYYY/MM/DD" style="width: 120px;"/></label></div><h3>Medication ADR (Adverse Drug Reaction)</h3><textarea id="hist_med_adr" rows="1" placeholder="unknown"></textarea><h3>Allergy to Medical Device and Materials</h3><div style="margin-top:6px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px;"><label class="toggle" style="flex-shrink: 0;"><input type="checkbox" id="hist_device_allergy_denied"/>Denied</label><input type="text" id="hist_device_allergy_details" placeholder="Details (e.g., Latex, Swelling)" style="flex-grow: 1; min-width: 150px;"/><label style="flex-shrink: 0;">Date: <input type="text" id="hist_device_allergy_date" placeholder="YYYY/MM/DD" style="width: 120px;"/></label></div><h3>Current Medication</h3><label>å°å¤§é†«é™¢ (Usually auto-filled): <input type="text" id="hist_current_med_ntuh" placeholder="Can be left blank or used for copy-paste"/></label><label>Other: <input type="text" id="hist_current_med_other" placeholder="denied"/></label><label>ä¸­è‰è—¥ (TCM): <input type="text" id="hist_current_med_tcm" placeholder="denied"/></label><label>ä¿å¥é£Ÿå“ (Supplements): <input type="text" id="hist_current_med_supplements" placeholder="denied"/></label><h3>Hospitalization History</h3><textarea id="hist_hospitalization_history" rows="4" placeholder="e.g., å…¥é™¢æ—¥æœŸ:YYYY_MM_DD å‡ºé™¢æ—¥æœŸ:YYYY_MM_DD è¨ºæ–·:"></textarea><h3>Past Surgical History</h3><textarea id="hist_surgical_history_detailed" rows="3" placeholder="denied"></textarea><h3>Family History</h3><div class="grid" id="fhGrid"><label class="toggle"><input type="checkbox" id="fh_HTN" />Hypertension</label><label class="toggle"><input type="checkbox" id="fh_DM" />Diabetes</label><label class="toggle"><input type="checkbox" id="fh_DLP" />Dyslipidemia</label><label class="toggle"><input type="checkbox" id="fh_CA" />Cancer</label><label class="toggle"><input type="checkbox" id="fh_CAD" />CAD</label></div><label>Family History Details:<textarea id="fh_details" rows="2" placeholder="e.g., Grandfather: DM, HTN
Grandmother: DM, HTN"></textarea></label><h3>TOCC</h3><details><summary>Travel, Occupation, Contact, Cluster</summary><div style="margin-top:6px;"><label>Travel: <input type="text" id="hist_tocc_travel" placeholder="denied"/></label><br/><label>Occupation: <input type="text" id="hist_tocc_occupation" placeholder="Office worker"/></label><br/><label>Cluster and contact: <input type="text" id="hist_tocc_cluster" placeholder="denied"/></label></div></details><h3>ABC</h3><details><summary>Personal Habits</summary><div style="margin-top:6px;"><label>Alcohol: <input type="text" id="hist_abc_alcohol" placeholder="denied"/></label><br/><label>Betel nuts: <input type="text" id="hist_abc_betel" placeholder="denied"/></label><br/><label>Smoking: <input type="text" id="hist_abc_smoking" placeholder="denied"/></label></div></details></section>
    <section id="psychosocialSection" data-title="Psychosocial"><h2>ç¤¾æœƒå¿ƒç†ç›¸é—œè©•ä¼° (Psychosocial Assessment)</h2><textarea id="psychosocial_assessment" rows="2" placeholder="pending"></textarea></section>
    <section id="dischargePlanningSection" data-title="Discharge Plan"><h2>å‡ºé™¢è¦åŠƒ (Discharge Planning)</h2><div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));"><label>ç®¡è·¯ç•™ç½®ç‹€æ³ï¼š<input type="text" id="dp_catheter" placeholder="Nil"/></label><label>æ—¥å¸¸ç”Ÿæ´»åŠŸèƒ½åˆ†æ•¸ï¼š<input type="text" id="dp_adl" placeholder="100"/></label><label>é æœŸå‡ºé™¢å¾Œå±…ä½å ´æ‰€ï¼š<input type="text" id="dp_residence" placeholder="èˆ‡å®¶äººåŒä½"/></label><label>é æœŸå‡ºé™¢å¾Œä¸»è¦ç…§é¡§è€…ï¼š<input type="text" id="dp_caregiver" placeholder="è‡ªå·±"/></label><label>å‡ºé™¢è¦åŠƒæ”¶æ¡ˆç¯©æª¢ï¼š<input type="text" id="dp_screening" placeholder="ä¸€èˆ¬ç—…æ‚£"/></label></div></section>
    <section id="vitalsSection" data-title="Vitals"><h2>Vitals</h2><div class="vitals-grid"><label>Height (cm): <input type="text" id="vitals_bh"/></label><label>Weight (kg): <input type="text" id="vitals_bw"/></label><label>Temp (Â°C): <input type="text" id="vitals_t"/></label><label>Pulse (bpm): <input type="text" id="vitals_p"/></label><label>Resp (/min): <input type="text" id="vitals_r"/></label><label>BP (mmHg): <input type="text" id="vitals_bp"/></label><label>Pain Score: <input type="text" id="vitals_pain"/></label></div></section>
    <section id="peSection" data-title="Physical Exam"><h2>Physical Examination</h2><h3>PE Narrative / General Appearance</h3><textarea id="pe_details" rows="3" placeholder="e.g., General appearance: fair body figure
breathing sound: crackles(+, right upper lobe)"></textarea><details open><summary>Neurological Examination</summary><div style="margin-top:6px;"><label>Consciousness: <input type="text" id="pe_neuro_conscious" placeholder="alert and oriented, GCS: E4M6V5"/></label><br/><label>Muscle power: <input type="text" id="pe_neuro_power" placeholder="can not perform"/></label><br/><label>Gait: <input type="text" id="pe_neuro_gait" placeholder="no test"/></label></div></details><details><summary>HEENT</summary><div class="grid"><label class="toggle"><input type="checkbox" id="pe_head_raccoon"/>Raccoon eye</label><label class="toggle"><input type="checkbox" id="pe_head_rash"/>Rash</label><label class="toggle"><input type="checkbox" id="pe_pupil_abn"/>Pupil abnormal</label><label class="toggle"><input type="checkbox" id="pe_eom_lim"/>EOM limited</label><label class="toggle"><input type="checkbox" id="pe_conj_pale"/>Conjunctiva pale</label><label class="toggle"><input type="checkbox" id="pe_sclera_icteric"/>Sclera icteric</label><label class="toggle"><input type="checkbox" id="pe_ear_def"/>Ear deformity</label><label class="toggle"><input type="checkbox" id="pe_ear_dis"/>Ear discharge</label><label class="toggle"><input type="checkbox" id="pe_ear_hi"/>Hearing impairment</label><label class="toggle"><input type="checkbox" id="pe_throat_mass"/>Throat mass</label><label class="toggle"><input type="checkbox" id="pe_throat_ulcer"/>Throat ulcer</label><label class="toggle"><input type="checkbox" id="pe_throat_ng"/>NG tube</label></div></details><details><summary>Neck</summary><div class="grid"><label class="toggle"><input type="checkbox" id="pe_neck_stiff"/>Stiffness</label><label class="toggle"><input type="checkbox" id="pe_neck_bruit"/>Bruit</label><label class="toggle"><input type="checkbox" id="pe_neck_jvp"/>Jugular engorgement</label><label class="toggle"><input type="checkbox" id="pe_neck_goiter"/>Goiter</label><label class="toggle"><input type="checkbox" id="pe_neck_lymph"/>Lymphadenopathy</label></div></details><details><summary>Chest</summary><div class="grid"><label class="toggle"><input type="checkbox" id="pe_chest_def"/>Chest deformity</label><label class="toggle"><input type="checkbox" id="pe_chest_spider"/>Spider angioma</label><label class="toggle"><input type="checkbox" id="pe_chest_lump"/>Lumps</label><label class="toggle"><input type="checkbox" id="pe_chest_discharge"/>Discharge</label><label class="toggle"><input type="checkbox" id="pe_chest_tender"/>Tenderness</label><label class="toggle"><input type="checkbox" id="pe_chest_crackles"/>Crackles</label><label class="toggle"><input type="checkbox" id="pe_chest_wheeze"/>Wheezing</label><label class="toggle"><input type="checkbox" id="pe_chest_rhonchi"/>Rhonchi</label><label class="toggle"><input type="checkbox" id="pe_chest_stridor"/>Stridor</label></div></details><details><summary>Heart</summary><div class="grid"><label class="toggle"><input type="checkbox" id="pe_heart_irreg"/>Irregular beat</label><label class="toggle"><input type="checkbox" id="pe_heart_murmur"/>Murmur</label><label class="toggle"><input type="checkbox" id="pe_heart_thrill"/>Thrill</label><label class="toggle"><input type="checkbox" id="pe_heart_pmi"/>Abnormal PMI</label></div></details><details><summary>Abdomen</summary><div class="grid"><label class="toggle"><input type="checkbox" id="pe_abd_dist"/>Distension</label><label class="toggle"><input type="checkbox" id="pe_abd_caput"/>Caput medusa</label><label class="toggle"><input type="checkbox" id="pe_abd_mass"/>Palpable mass</label><label class="toggle"><input type="checkbox" id="pe_abd_tender"/>Tenderness</label><label class="toggle"><input type="checkbox" id="pe_abd_hjr"/>Hepato-jugular reflux</label></div></details><details><summary>Back</summary><div class="grid"><label class="toggle"><input type="checkbox" id="pe_back_cv"/>CV angle knocking pain</label></div></details><details><summary>Extremities</summary><div class="grid"><label class="toggle"><input type="checkbox" id="pe_ext_lim"/>Limitation of movement</label><label class="toggle"><input type="checkbox" id="pe_ext_def"/>Deformity</label><label class="toggle"><input type="checkbox" id="pe_ext_cyano"/>Cyanosis</label><label class="toggle"><input type="checkbox" id="pe_ext_edema"/>Pitting edema</label></div></details><details><summary>Skin</summary><div class="grid"><label class="toggle"><input type="checkbox" id="pe_skin_rash"/>Rash</label><label class="toggle"><input type="checkbox" id="pe_skin_tumor"/>Tumor</label><label class="toggle"><input type="checkbox" id="pe_skin_pete"/>Petechiae</label><label class="toggle"><input type="checkbox" id="pe_skin_ecch"/>Ecchymosis</label><label class="toggle"><input type="checkbox" id="pe_skin_purp"/>Purpura</label><label class="toggle"><input type="checkbox" id="pe_skin_depig"/>Depigmentation</label><label class="toggle"><input type="checkbox" id="pe_skin_hyperpig"/>Abnormal pigmentation</label><label class="toggle"><input type="checkbox" id="pe_skin_tel"/>Telangiectasia</label></div></details></section>
    <section id="rosSection" data-title="Review of Systems"><h2>Review of Systems (ROS)</h2><h3>ROS Details</h3><textarea id="ros_details" rows="2" placeholder="e.g., Respiratory: dyspnea(-), chest pain(-), productive cough (+, for 6 months)"></textarea><details open><summary>Systemic</summary><div class="grid"><label class="toggle"><input type="checkbox" id="ros_sys_fever"/>fever</label><label class="toggle"><input type="checkbox" id="ros_sys_chills"/>chills</label><label class="toggle"><input type="checkbox" id="ros_sys_night_sweats"/>night sweats</label><label class="toggle"><input type="checkbox" id="ros_sys_fatigue"/>fatigue</label><label class="toggle"><input type="checkbox" id="ros_sys_conscious_dist"/>consciousness disturbance</label><label class="toggle"><input type="checkbox" id="ros_sys_insomnia"/>insomnia</label><label class="toggle"><input type="checkbox" id="ros_sys_weight_change"/>weight change</label><label class="toggle"><input type="checkbox" id="ros_sys_appetite_dec"/>decreased appetite</label></div></details><details><summary>HEENT</summary><div class="grid"><label class="toggle"><input type="checkbox" id="ros_heent_headache"/>headache</label><label class="toggle"><input type="checkbox" id="ros_heent_dizziness"/>dizziness</label><label class="toggle"><input type="checkbox" id="ros_heent_vertigo"/>vertigo</label><label class="toggle"><input type="checkbox" id="ros_heent_diplopia"/>diplopia</label><label class="toggle"><input type="checkbox" id="ros_heent_visual_field_defect"/>visual field defect</label><label class="toggle"><input type="checkbox" id="ros_heent_blurred_vision"/>blurred vision</label><label class="toggle"><input type="checkbox" id="ros_heent_ocular_pain"/>ocular pain</label><label class="toggle"><input type="checkbox" id="ros_heent_tinnitus"/>tinnitus</label><label class="toggle"><input type="checkbox" id="ros_heent_otalgia"/>otalgia</label><label class="toggle"><input type="checkbox" id="ros_heent_otorrhea"/>otorrhea</label><label class="toggle"><input type="checkbox" id="ros_heent_hearing_impairment"/>hearing impairment</label><label class="toggle"><input type="checkbox" id="ros_heent_nasal_congestion"/>nasal congestion</label><label class="toggle"><input type="checkbox" id="ros_heent_nasal_discharge"/>nasal discharge</label><label class="toggle"><input type="checkbox" id="ros_heent_sore_throat"/>sore throat</label><label class="toggle"><input type="checkbox" id="ros_heent_gum_bleeding"/>gum bleeding</label><label class="toggle"><input type="checkbox" id="ros_heent_dysphagia"/>dysphagia</label><label class="toggle"><input type="checkbox" id="ros_heent_hoarseness"/>hoarseness</label><label class="toggle"><input type="checkbox" id="ros_heent_oral_ulcers"/>oral ulcers</label></div></details><details><summary>Cardiorespiratory</summary><div class="grid"><label class="toggle"><input type="checkbox" id="ros_cardio_chest_pain"/>chest pain</label><label class="toggle"><input type="checkbox" id="ros_cardio_exertional_dyspnea"/>exertional dyspnea</label><label class="toggle"><input type="checkbox" id="ros_cardio_nocturnal_dyspnea"/>nocturnal dyspnea</label><label class="toggle"><input type="checkbox" id="ros_cardio_orthopnea"/>orthopnea</label><label class="toggle"><input type="checkbox" id="ros_cardio_pitting_edema"/>pitting edema</label><label class="toggle"><input type="checkbox" id="ros_cardio_syncope"/>syncope</label><label class="toggle"><input type="checkbox" id="ros_cardio_palpitation"/>palpitation</label><label class="toggle"><input type="checkbox" id="ros_cardio_intermittent_claudication"/>intermittent claudication</label><label class="toggle"><input type="checkbox" id="ros_cardio_dyspnea"/>dyspnea</label><label class="toggle"><input type="checkbox" id="ros_cardio_cough"/>cough</label><label class="toggle"><input type="checkbox" id="ros_cardio_sputum"/>sputum</label><label class="toggle"><input type="checkbox" id="ros_cardio_hemoptysis"/>hemoptysis</label><label class="toggle"><input type="checkbox" id="ros_cardio_wheezes"/>wheezes</label><label class="toggle"><input type="checkbox" id="ros_cardio_chest_tightness"/>chest tightness</label></div></details><details><summary>Gastrointestinal</summary><div class="grid"><label class="toggle"><input type="checkbox" id="ros_gi_anorexia"/>anorexia</label><label class="toggle"><input type="checkbox" id="ros_gi_nausea"/>nausea</label><label class="toggle"><input type="checkbox" id="ros_gi_vomiting"/>vomiting</label><label class="toggle"><input type="checkbox" id="ros_gi_acid_regurgitation"/>acid regurgitation</label><label class="toggle"><input type="checkbox" id="ros_gi_abdominal_pain"/>abdominal pain</label><label class="toggle"><input type="checkbox" id="ros_gi_abdominal_distention"/>abdominal distention</label><label class="toggle"><input type="checkbox" id="ros_gi_dysphagia"/>dysphagia</label><label class="toggle"><input type="checkbox" id="ros_gi_dyspepsia"/>dyspepsia</label><label class="toggle"><input type="checkbox" id="ros_gi_hematemesis"/>hematemesis</label><label class="toggle"><input type="checkbox" id="ros_gi_diarrhea"/>diarrhea</label><label class="toggle"><input type="checkbox" id="ros_gi_constipation"/>constipation</label><label class="toggle"><input type="checkbox" id="ros_gi_melena"/>melena</label><label class="toggle"><input type="checkbox" id="ros_gi_hematochezia"/>hematochezia</label><label class="toggle"><input type="checkbox" id="ros_gi_tenesmus"/>tenesmus</label><label class="toggle"><input type="checkbox" id="ros_gi_small_caliber_stool"/>small caliber stool</label></div></details><details><summary>Genitourinary</summary><div class="grid"><label class="toggle"><input type="checkbox" id="ros_gu_urinary_frequency"/>urinary frequency</label><label class="toggle"><input type="checkbox" id="ros_gu_urgency"/>urgency</label><label class="toggle"><input type="checkbox" id="ros_gu_nocturia"/>nocturia</label><label class="toggle"><input type="checkbox" id="ros_gu_incontinence"/>incontinence</label><label class="toggle"><input type="checkbox" id="ros_gu_weak_stream"/>weak urinary stream</label><label class="toggle"><input type="checkbox" id="ros_gu_hesitancy"/>hesitancy</label><label class="toggle"><input type="checkbox" id="ros_gu_incomplete_voiding"/>incomplete voiding</label><label class="toggle"><input type="checkbox" id="ros_gu_terminal_dribbling"/>terminal dribbling</label><label class="toggle"><input type="checkbox" id="ros_gu_dysuria"/>dysuria</label><label class="toggle"><input type="checkbox" id="ros_gu_hematuria"/>hematuria</label><label class="toggle"><input type="checkbox" id="ros_gu_flank_pain"/>flank pain</label><label class="toggle"><input type="checkbox" id="ros_gu_polyuria"/>polyuria</label><label class="toggle"><input type="checkbox" id="ros_gu_oliguria"/>oliguria</label></div></details><details><summary>Musculoskeletal</summary><div class="grid"><label class="toggle"><input type="checkbox" id="ros_msk_arthralgia"/>arthralgia</label><label class="toggle"><input type="checkbox" id="ros_msk_joint_stiffness"/>joint stiffness</label><label class="toggle"><input type="checkbox" id="ros_msk_joint_swelling"/>joint swelling</label><label class="toggle"><input type="checkbox" id="ros_msk_myalgia"/>myalgia</label><label class="toggle"><input type="checkbox" id="ros_msk_cramps"/>cramps</label><label class="toggle"><input type="checkbox" id="ros_msk_bone_pain"/>bone pain</label><label class="toggle"><input type="checkbox" id="ros_msk_back_pain"/>back pain</label><label class="toggle"><input type="checkbox" id="ros_msk_fractures"/>fractures</label></div></details><details><summary>Nervous</summary><div class="grid"><label class="toggle"><input type="checkbox" id="ros_neuro_blurred_vision"/>blurred vision</label><label class="toggle"><input type="checkbox" id="ros_neuro_hearing_impairment"/>hearing impairment</label><label class="toggle"><input type="checkbox" id="ros_neuro_speech_problem"/>speech problem</label><label class="toggle"><input type="checkbox" id="ros_neuro_numbness"/>numbness</label><label class="toggle"><input type="checkbox" id="ros_neuro_paraesthesia"/>paraesthesia</label><label class="toggle"><input type="checkbox" id="ros_neuro_allodynia"/>allodynia</label><label class="toggle"><input type="checkbox" id="ros_neuro_paresis_plegia"/>paresis/plegia</label><label class="toggle"><input type="checkbox" id="ros_neuro_gait_disturbance"/>gait disturbance</label><label class="toggle"><input type="checkbox" id="ros_neuro_sphincter_disturbance"/>sphincter disturbance</label><label class="toggle"><input type="checkbox" id="ros_neuro_convulsion"/>convulsion</label><label class="toggle"><input type="checkbox" id="ros_neuro_resting_tremor"/>resting tremor</label></div></details><details><summary>Skin</summary><div class="grid"><label class="toggle"><input type="checkbox" id="ros_skin_color_changes"/>color changes</label><label class="toggle"><input type="checkbox" id="ros_skin_jaundice"/>jaundice</label><label class="toggle"><input type="checkbox" id="ros_skin_rash"/>rash</label><label class="toggle"><input type="checkbox" id="ros_skin_itching"/>itching</label><label class="toggle"><input type="checkbox" id="ros_skin_petechiae"/>petechiae</label><label class="toggle"><input type="checkbox" id="ros_skin_ecchymoses"/>ecchymoses</label><label class="toggle"><input type="checkbox" id="ros_skin_purpura"/>purpura</label></div></details></section>
    <section id="imagingSection" data-title="Imaging Report"><h2>å½±åƒå ±å‘Š (Imaging Report)</h2><textarea id="imaging_report" rows="6" placeholder="e.g., MRI Head and Neck 2026/01/09: No definite local tumour recurrence. No enlarged cervical lymph nodes.

CXR 2026/01/09: No cardiomegaly, no obvious pneumonia patch."></textarea></section>
    <section id="pathologySection" data-title="Pathology Report"><h2>ç—…ç†å ±å‘Š (Pathology Report)</h2><textarea id="pathology_report" rows="4" placeholder="nil (if no pathology report)"></textarea></section>
    <section id="diagnosisSection" data-title="Tentative Diagnosis"><h2>è‡†æ–· (Tentative Diagnosis)</h2><h3>[Active]</h3><textarea id="diagnosis_active" rows="3" placeholder="#. Main diagnosis for this admission
- status post treatment if applicable"></textarea><h3>[Underlying]</h3><textarea id="diagnosis_underlying" rows="4" placeholder="#. Underlying condition 1
#. Underlying condition 2
#. Underlying condition 3"></textarea></section>
    <section id="planSection" data-title="SOAP Note"><h2>é†«ç™‚éœ€æ±‚èˆ‡æ²»ç™‚è¨ˆç•« (Medical Needs and Care Plan)</h2><label>Age and sex: <input type="text" id="plan_age_sex" placeholder="e.g., 99F"></label><h3 style="margin-top:20px;">S: Subjective</h3><p style="padding: 10px 12px; background: #e9ecef; border-radius: var(--radius); border: 1px solid var(--border);">This will be auto-filled from the Chief Complaint section.</p><h3 style="margin-top:20px;">O: Objective</h3><h4>Key Physical Examination Findings</h4><textarea id="plan_pe_findings" rows="2" placeholder="e.g., breathing sound: crackles(+, somewhere out there)"></textarea><h4>Lab</h4><textarea id="plan_lab_data" rows="4" placeholder="Significant lab data"></textarea><h4>EKG</h4><div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;"><label style="flex-basis: 200px;">Date: <input type="text" id="plan_ekg_date" placeholder="YYYY/MM/DD"></label><label style="flex-grow: 1;">Interpretation: <input type="text" id="plan_ekg_interp" placeholder="Normal sinus rhythm"></label></div><h4>CXR</h4><div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap; margin-top: 8px;"><label style="flex-basis: 200px;">Date: <input type="text" id="plan_cxr_date" placeholder="YYYY/MM/DD"></label><label style="flex-grow: 1;">Interpretation: <input type="text" id="plan_cxr_interp" placeholder="No cardiomegaly. No obvious pneumonia patch."></label></div><h3 style="margin-top:20px;">A: Assessment</h3><h4>Active Problems</h4><textarea id="plan_assessment_active" rows="2" placeholder="#. Fever, suspect infection..."></textarea><h4>Underlying Conditions</h4><textarea id="plan_assessment_underlying" rows="3" placeholder="I think I saw this somewhere..."></textarea><h3 style="margin-top:20px;">P: Plan</h3><textarea id="plan_plan" rows="3" placeholder="1. Keep current treatment...
2. Check some kind of lab
3. Arrange some kind of test"></textarea><label>Treatment Goal: <input type="text" id="plan_treatment_goal" placeholder="Resolve symptoms and discharge without complications"/></label></section>
  </div>

  <div id="controls">
    <div class="button-group">
      <button id="copyHistoryBtn" class="button">Copy History Block</button>
      <button id="copyFullNoteBtn" class="button">Copy Full Note</button>
    </div>
    <h2>Output Preview</h2>
    <div id="noteOutputContainer">
      <div id="noteOutput"></div>
    </div>
  </div>

  <div id="copy-toast">Note Copied!</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ELEMENT SELECTORS ---
    const STORAGE_KEY_DATA = 'admissionNoteData_AI';
    const STORAGE_KEY_BG = 'admissionNoteBackground';
    const STORAGE_KEY_API = 'geminiApiKey';
    const blockContainer = document.getElementById('blockContainer');
    const sectionsContainer = document.getElementById('sectionsContainer');
    const allFormElements = Array.from(sectionsContainer.querySelectorAll('input, textarea'));
    const modalOverlay = document.getElementById('modalOverlay');
    const modalBody = document.getElementById('modalBody');
    const modalClose = document.getElementById('modalClose');
    const copyFullNoteBtn = document.getElementById('copyFullNoteBtn');
    const copyHistoryBtn = document.getElementById('copyHistoryBtn');
    const outputContainer = document.getElementById('noteOutputContainer');
    const noteOutputEl = document.getElementById('noteOutput');
    const copyToast = document.getElementById('copy-toast');
    const settingsGear = document.getElementById('settings-gear');
    const settingsMenu = document.getElementById('settings-menu');
    const backgroundInput = document.getElementById('background-input');
    const resetBackgroundBtn = document.getElementById('reset-background');
    const clearDataBtn = document.getElementById('clear-data');
    const clearApiKeyBtn = document.getElementById('clear-api-key');
    const allSections = Array.from(sectionsContainer.querySelectorAll('section'));
    const blocks = {};

    // AI Elements
    const aiInputArea = document.getElementById('aiInputArea');
    const parseBtn = document.getElementById('parseBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const voiceIcon = document.getElementById('voiceIcon');
    const voiceText = document.getElementById('voiceText');
    const clearAiBtn = document.getElementById('clearAiBtn');
    const aiStatus = document.getElementById('aiStatus');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const saveApiKeyBtn = document.getElementById('saveApiKey');
    const apiKeyStatus = document.getElementById('apiKeyStatus');
    const apiKeySetup = document.getElementById('apiKeySetup');

    // Voice recognition
    let recognition = null;
    let isRecording = false;

    // --- HELPER FUNCTIONS ---
    const getVal = (id, defaultVal = 'N/A') => {
        const el = document.getElementById(id);
        return el && el.value.trim() ? el.value.trim() : defaultVal;
    };
    const plusMinus = (cbId) => {
        const el = document.getElementById(cbId);
        return el && el.checked ? "â– " : "â–¡";
    };

    // --- API KEY MANAGEMENT ---
    const checkApiKey = () => {
        const savedKey = localStorage.getItem(STORAGE_KEY_API);
        if (savedKey) {
            apiKeySetup.style.display = 'none';
            parseBtn.disabled = false;
            return savedKey;
        }
        return null;
    };

    saveApiKeyBtn.addEventListener('click', () => {
        const key = apiKeyInput.value.trim();
        if (key) {
            localStorage.setItem(STORAGE_KEY_API, key);
            apiKeyStatus.textContent = ' âœ“ Saved!';
            apiKeyStatus.className = 'api-key-saved';
            setTimeout(() => {
                apiKeySetup.style.display = 'none';
                parseBtn.disabled = false;
            }, 1000);
        }
    });

    clearApiKeyBtn.addEventListener('click', () => {
        localStorage.removeItem(STORAGE_KEY_API);
        apiKeySetup.style.display = 'block';
        apiKeyInput.value = '';
        apiKeyStatus.textContent = '';
        parseBtn.disabled = true;
        settingsMenu.style.display = 'none';
    });

    // --- AI PARSING ---
    const showStatus = (message, type) => {
        aiStatus.textContent = message;
        aiStatus.className = type;
    };

    const hideStatus = () => {
        aiStatus.className = '';
        aiStatus.style.display = 'none';
    };

    const parseWithAI = async () => {
        const apiKey = localStorage.getItem(STORAGE_KEY_API);
        const inputText = aiInputArea.value.trim();

        if (!apiKey) {
            showStatus('Please enter your Gemini API key first.', 'error');
            return;
        }

        if (!inputText) {
            showStatus('Please enter some notes to parse.', 'error');
            return;
        }

        parseBtn.disabled = true;
        showStatus('Parsing with AI... This may take a few seconds.', 'loading');

        const prompt = `Parse clinical notes to JSON for NTUH EMR. Output in ENGLISH only (translate Chinese if needed). Use null for missing info.

Extract these fields:
- chief_complaint: brief chief complaint for admission
- age_sex: format as "*49M" or "*65F" (asterisk + age + sex)
- patient_narrative: format as "This is a XX-year-old male/female with underlying disease of\\n#. Disease 1\\n#. Disease 2\\n\\nThe patient was..."
- past_medical_history: numbered list with #. prefix
- past_surgical_history: format as "YYYY_MM_DD  Procedure name"
- hospitalization_history: format as "å…¥é™¢æ—¥æœŸ:YYYY_MM_DD å‡ºé™¢æ—¥æœŸ:YYYY_MM_DD è¨ºæ–·:..."
- medication_allergy: {denied: boolean, details: string}
- current_medications: string
- family_history: {HTN, DM, DLP, Cancer, CAD, details}
- social_history: {alcohol, smoking, betel} - use "denied" or describe
- tocc: {travel, occupation, contact, cluster}
- vitals: {temperature, pulse, respiration, bp, height, weight, pain}
- physical_exam: {general, consciousness, chest, heart, abdomen, extremities, neurological, local_findings}

Generate Tentative Diagnosis (è‡†æ–·):
- diagnosis_active: format as "[Active]\\n#. Main problem for admission\\n- status post treatment if any"
- diagnosis_underlying: format as "[Underlying]\\n#. Condition 1\\n#. Condition 2"

Generate SOAP for Medical Needs and Care Plan (é†«ç™‚éœ€æ±‚èˆ‡æ²»ç™‚è¨ˆç•«):
- soap_s: chief complaint in bullet format "- symptom noted during..."
- soap_o_general: format as "[General]\\n- code : full/aggressive\\n- vital signs: stable/unstable\\n- Consciousness: E4V5M6"
- soap_o_local: "[Local findings]\\n- describe relevant findings"
- soap_o_lab: "[lab]\\n- Hemogram: ...\\n- BCS: ..."
- soap_o_image: "[image]\\n- CXR (-)\\n- ECG : NSR"
- soap_a_active: same as diagnosis_active
- soap_a_underlying: same as diagnosis_underlying
- soap_plan: format as "- treatment step 1\\n- treatment step 2\\n- monitoring plan"
- treatment_goal: "- goal description"

Notes:
${inputText}

Return only valid JSON.`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 2048,
                    }
                })
            });

            if (response.status === 429) {
                showStatus('Rate limited. Retrying in 3 seconds...', 'loading');
                await new Promise(r => setTimeout(r, 3000));
                return parseWithAI(); // Retry once
            }

            if (!response.ok) {
                throw new Error(`API request failed: ${response.status}`);
            }

            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;

            // Extract JSON from response (handle markdown code blocks)
            let jsonStr = text;
            if (text.includes('```json')) {
                jsonStr = text.split('```json')[1].split('```')[0];
            } else if (text.includes('```')) {
                jsonStr = text.split('```')[1].split('```')[0];
            }

            const parsed = JSON.parse(jsonStr.trim());
            populateForm(parsed);
            showStatus('Successfully parsed and populated form fields!', 'success');
            setTimeout(hideStatus, 3000);

        } catch (error) {
            console.error('AI parsing error:', error);
            showStatus(`Error: ${error.message}. Please check your API key and try again.`, 'error');
        } finally {
            parseBtn.disabled = false;
        }
    };

    const populateForm = (data) => {
        // Helper to set field value and highlight
        const setField = (id, value) => {
            if (value === null || value === undefined) return;
            const el = document.getElementById(id);
            if (el) {
                el.value = value;
                el.classList.add('ai-populated');
                // Trigger input event for auto-save
                el.dispatchEvent(new Event('input', { bubbles: true }));
            }
        };

        const setCheckbox = (id, checked) => {
            if (checked === null || checked === undefined) return;
            const el = document.getElementById(id);
            if (el) {
                el.checked = checked;
                el.dispatchEvent(new Event('change', { bubbles: true }));
            }
        };

        // Chief Complaint
        if (data.chief_complaint) setField('ccpi', data.chief_complaint);
        if (data.present_illness) setField('ccpi', data.present_illness);

        // Age/Sex for SOAP
        if (data.age_sex) setField('plan_age_sex', data.age_sex);

        // Patient Narrative
        if (data.patient_narrative) setField('patientHistoryNarrative', data.patient_narrative);

        // Past Medical History
        if (data.past_medical_history) setField('hist_pmh', data.past_medical_history);

        // Past Surgical History
        if (data.past_surgical_history) setField('hist_surgical_history_detailed', data.past_surgical_history);

        // Medication Allergy
        if (data.medication_allergy) {
            if (data.medication_allergy.denied) {
                setCheckbox('hist_med_allergy_denied', true);
            } else if (data.medication_allergy.details) {
                setField('hist_med_allergy_details', data.medication_allergy.details);
            }
        }

        // Device Allergy
        if (data.device_allergy) {
            if (data.device_allergy.denied) {
                setCheckbox('hist_device_allergy_denied', true);
            } else if (data.device_allergy.details) {
                setField('hist_device_allergy_details', data.device_allergy.details);
            }
        }

        // Current Medications
        if (data.current_medications) setField('hist_current_med_other', data.current_medications);

        // Family History
        if (data.family_history) {
            setCheckbox('fh_HTN', data.family_history.HTN);
            setCheckbox('fh_DM', data.family_history.DM);
            setCheckbox('fh_DLP', data.family_history.DLP);
            setCheckbox('fh_CA', data.family_history.Cancer);
            setCheckbox('fh_CAD', data.family_history.CAD);
            if (data.family_history.details) setField('fh_details', data.family_history.details);
        }

        // Social History
        if (data.social_history) {
            if (data.social_history.alcohol) setField('hist_abc_alcohol', data.social_history.alcohol);
            if (data.social_history.smoking) setField('hist_abc_smoking', data.social_history.smoking);
            if (data.social_history.betel) setField('hist_abc_betel', data.social_history.betel);
        }

        // Vitals
        if (data.vitals) {
            if (data.vitals.temperature) setField('vitals_t', data.vitals.temperature);
            if (data.vitals.pulse) setField('vitals_p', data.vitals.pulse);
            if (data.vitals.respiration) setField('vitals_r', data.vitals.respiration);
            if (data.vitals.bp) setField('vitals_bp', data.vitals.bp);
            if (data.vitals.height) setField('vitals_bh', data.vitals.height);
            if (data.vitals.weight) setField('vitals_bw', data.vitals.weight);
        }

        // Physical Exam
        if (data.physical_exam) {
            let peNarrative = [];
            if (data.physical_exam.general) peNarrative.push(`General: ${data.physical_exam.general}`);
            if (data.physical_exam.heent) peNarrative.push(`HEENT: ${data.physical_exam.heent}`);
            if (data.physical_exam.neck) peNarrative.push(`Neck: ${data.physical_exam.neck}`);
            if (data.physical_exam.chest) peNarrative.push(`Chest: ${data.physical_exam.chest}`);
            if (data.physical_exam.heart) peNarrative.push(`Heart: ${data.physical_exam.heart}`);
            if (data.physical_exam.abdomen) peNarrative.push(`Abdomen: ${data.physical_exam.abdomen}`);
            if (data.physical_exam.extremities) peNarrative.push(`Extremities: ${data.physical_exam.extremities}`);
            if (data.physical_exam.skin) peNarrative.push(`Skin: ${data.physical_exam.skin}`);
            if (peNarrative.length > 0) setField('pe_details', peNarrative.join('\n'));

            if (data.physical_exam.consciousness) setField('pe_neuro_conscious', data.physical_exam.consciousness);
        }

        // PE Checkboxes
        if (data.pe_checkboxes) {
            Object.keys(data.pe_checkboxes).forEach(key => {
                setCheckbox(key, data.pe_checkboxes[key]);
            });
        }

        // ROS Checkboxes
        if (data.ros_checkboxes) {
            Object.keys(data.ros_checkboxes).forEach(key => {
                setCheckbox(key, data.ros_checkboxes[key]);
            });
        }

        // ROS Details
        if (data.ros_positive && data.ros_positive.length > 0) {
            setField('ros_details', data.ros_positive.join(', '));
        }

        // TOCC
        if (data.tocc) {
            if (data.tocc.travel) setField('hist_tocc_travel', data.tocc.travel);
            if (data.tocc.occupation) setField('hist_tocc_occupation', data.tocc.occupation);
            if (data.tocc.contact) setField('hist_tocc_cluster', data.tocc.contact);
            if (data.tocc.cluster) setField('hist_tocc_cluster', data.tocc.cluster);
        }

        // Hospitalization History
        if (data.hospitalization_history) setField('hist_hospitalization_history', data.hospitalization_history);

        // Tentative Diagnosis (è‡†æ–·)
        if (data.diagnosis_active) {
            const activeText = data.diagnosis_active.replace('[Active]\n', '').replace('[Active]', '');
            setField('diagnosis_active', activeText);
        }
        if (data.diagnosis_underlying) {
            const underlyingText = data.diagnosis_underlying.replace('[Underlying]\n', '').replace('[Underlying]', '');
            setField('diagnosis_underlying', underlyingText);
        }

        // SOAP Section - O (Objective)
        if (data.soap_pe_findings) setField('plan_pe_findings', data.soap_pe_findings);
        if (data.soap_o_general) setField('plan_pe_findings', data.soap_o_general);
        if (data.soap_o_lab) setField('plan_lab_data', data.soap_o_lab.replace('[lab]\n', '').replace('[lab]', ''));

        // SOAP Section - A (Assessment)
        if (data.soap_a_active) {
            const activeText = data.soap_a_active.replace('[Active]\n', '').replace('[Active]', '');
            setField('plan_assessment_active', activeText);
        } else if (data.soap_active) {
            setField('plan_assessment_active', data.soap_active);
        }

        if (data.soap_a_underlying) {
            const underlyingText = data.soap_a_underlying.replace('[Underlying]\n', '').replace('[Underlying]', '');
            setField('plan_assessment_underlying', underlyingText);
        } else if (data.soap_underlying) {
            setField('plan_assessment_underlying', data.soap_underlying);
        }

        // SOAP Section - P (Plan)
        if (data.soap_plan) setField('plan_plan', data.soap_plan);
        if (data.treatment_goal) setField('plan_treatment_goal', data.treatment_goal.replace('- ', ''));

        // Legacy fields (fallback)
        if (data.assessment && !data.soap_active && !data.soap_a_active) setField('plan_assessment_active', data.assessment);
        if (data.plan && !data.soap_plan) setField('plan_plan', data.plan);

        // Update UI
        saveData();
    };

    parseBtn.addEventListener('click', parseWithAI);

    clearAiBtn.addEventListener('click', () => {
        aiInputArea.value = '';
        hideStatus();
    });

    // --- VOICE RECOGNITION ---
    const voiceLangSelect = document.getElementById('voiceLang');

    const updateVoiceButtonText = () => {
        const isChinese = voiceLangSelect.value === 'zh-TW';
        if (!isRecording) {
            voiceText.textContent = isChinese ? 'é–‹å§‹éŒ„éŸ³' : 'Start Recording';
        }
    };

    voiceLangSelect.addEventListener('change', () => {
        updateVoiceButtonText();
        // Reset recognition to use new language
        if (recognition) {
            recognition.lang = voiceLangSelect.value;
        }
    });

    const initVoiceRecognition = () => {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = voiceLangSelect.value; // Use selected language

            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (finalTranscript) {
                    aiInputArea.value += finalTranscript;
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                stopRecording();
                const isChinese = voiceLangSelect.value === 'zh-TW';
                showStatus(isChinese ? `èªéŸ³éŒ¯èª¤: ${event.error}` : `Voice error: ${event.error}`, 'error');
            };

            recognition.onend = () => {
                if (isRecording) {
                    // Restart if still recording (browser sometimes stops)
                    recognition.start();
                }
            };

            return true;
        }
        return false;
    };

    const startRecording = () => {
        // Re-init to get current language setting
        recognition = null;
        if (!initVoiceRecognition()) {
            showStatus('Voice recognition not supported in this browser. Try Chrome.', 'error');
            return;
        }

        const isChinese = voiceLangSelect.value === 'zh-TW';
        isRecording = true;
        voiceBtn.classList.add('recording');
        voiceIcon.textContent = 'â¹ï¸';
        voiceText.textContent = isChinese ? 'åœæ­¢éŒ„éŸ³' : 'Stop Recording';
        recognition.start();
        showStatus(isChinese ? 'æ­£åœ¨è†è½... è«‹æ¸…æ¥šèªªè©±' : 'Listening... Speak clearly.', 'loading');
    };

    const stopRecording = () => {
        const isChinese = voiceLangSelect.value === 'zh-TW';
        isRecording = false;
        voiceBtn.classList.remove('recording');
        voiceIcon.textContent = 'ğŸ¤';
        voiceText.textContent = isChinese ? 'é–‹å§‹éŒ„éŸ³' : 'Start Recording';
        if (recognition) {
            recognition.stop();
        }
        hideStatus();
    };

    voiceBtn.addEventListener('click', () => {
        if (isRecording) {
            stopRecording();
        } else {
            startRecording();
        }
    });

    // --- UI & STATE MANAGEMENT ---
    const isSectionFilled = (section) => {
        const inputs = section.querySelectorAll('input[type="text"], textarea');
        for (const input of inputs) {
            if (input.value.trim() !== '') return true;
        }
        const checkboxes = section.querySelectorAll('input[type="checkbox"]');
        for (const checkbox of checkboxes) {
            if (checkbox.checked) return true;
        }
        return false;
    };

    const updateUIState = () => {
        let allCompleted = true;
        allSections.forEach(section => {
            const block = blocks[section.id];
            if (isSectionFilled(section)) {
                block.classList.add('completed');
            } else {
                block.classList.remove('completed');
                allCompleted = false;
            }
        });
        copyFullNoteBtn.classList.toggle('ready', allCompleted);
        generateNotePreview();
    };

    const showToast = (message) => {
        copyToast.textContent = message;
        copyToast.classList.add('show');
        setTimeout(() => copyToast.classList.remove('show'), 2000);
    };

    // --- LOCAL STORAGE ---
    const saveData = () => {
        const data = {};
        allFormElements.forEach(el => {
            data[el.id] = el.type === 'checkbox' ? el.checked : el.value;
        });
        localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(data));
        updateUIState();
    };

    const loadData = () => {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY_DATA));
        if (data) {
            allFormElements.forEach(el => {
                if (data[el.id] !== undefined) {
                    el.type === 'checkbox' ? el.checked = data[el.id] : el.value = data[el.id];
                }
            });
        }
        const savedBg = localStorage.getItem(STORAGE_KEY_BG);
        if (savedBg) {
            document.body.style.backgroundImage = `url(${savedBg})`;
        }
        updateUIState();
    };

    // --- NOTE GENERATION ---
    const addSectionToOutput = (title, content, container) => {
        if (!content || content.trim() === '' || content.trim() === 'N/A') return;
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'output-section';
        const sanitizedContent = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        sectionDiv.innerHTML = `
            <h3>${title}<button class="copy-section-btn" title="Copy this section">ğŸ“‹</button></h3>
            <div class="output-content">${sanitizedContent}</div>
        `;
        container.appendChild(sectionDiv);
    };

    const compileROS = () => {
        let rosOutput = "ç³»çµ±æ€§å›é¡§(Review of Systems)\n(â– : positive, â–¡:negative)";
        const INDENT = "    ";
        const ITEMS_PER_LINE = 3;
        const rosDetails = getVal('ros_details', '');
        if (rosDetails) rosOutput += `\n${rosDetails}\n`;

        document.querySelectorAll('#rosSection details').forEach(det => {
            const sysTitle = det.querySelector('summary').textContent.trim();
            const items = det.querySelectorAll('input[type="checkbox"]');
            const formattedParts = Array.from(items).map(cb => `${plusMinus(cb.id)} ${cb.parentElement.textContent.trim()}`);

            let systemItemsString = "";
            for (let i = 0; i < formattedParts.length; i++) {
                systemItemsString += formattedParts[i];
                if (i < formattedParts.length - 1) {
                    systemItemsString += ", ";
                    if ((i + 1) % ITEMS_PER_LINE === 0) systemItemsString += "\n" + INDENT;
                }
            }
            rosOutput += `\n- ${sysTitle}:\n${INDENT}${systemItemsString}`;
        });
        return rosOutput.trim();
    };

    const assembleHistoryBlock = () => {
        const medAllergyDenied = document.getElementById('hist_med_allergy_denied').checked;
        const medAllergyDetails = getVal('hist_med_allergy_details', '');
        const medAllergyDate = getVal('hist_med_allergy_date', '');
        let medAllergyStr = medAllergyDenied ? 'No known' : (medAllergyDetails || 'unknown');
        if (!medAllergyDenied && medAllergyDate) medAllergyStr += ` (${medAllergyDate})`;

        const deviceAllergyDenied = document.getElementById('hist_device_allergy_denied').checked;
        const deviceAllergyDetails = getVal('hist_device_allergy_details', '');
        const deviceAllergyDate = getVal('hist_device_allergy_date', '');
        let deviceAllergyStr = deviceAllergyDenied ? 'No known' : (deviceAllergyDetails || 'unknown');
        if (!deviceAllergyDenied && deviceAllergyDate) deviceAllergyStr += ` (${deviceAllergyDate})`;

        const fhArr = [ `HTN ${plusMinus('fh_HTN')}`, `DM ${plusMinus('fh_DM')}`, `DLP ${plusMinus('fh_DLP')}`, `Cancer ${plusMinus('fh_CA')}`, `CAD ${plusMinus('fh_CAD')}` ];
        let fhStr = fhArr.join(', ');
        const fhDetails = getVal('fh_details', '');
        if (fhDetails) fhStr += `\n${fhDetails}`;

        const historyContent = `ç—…å²(Patient History)\n${getVal('patientHistoryNarrative', 'Not specified')}`;
        const pmhContent = `[Past medical history]\n${getVal('hist_pmh', 'Not specified')}`;
        const pshContent = `[Past surgical history]\n${getVal('hist_surgical_history_detailed', 'denied')}`;
        const hospContent = `[Hospitalization]\n${getVal('hist_hospitalization_history', 'denied')}`;
        const medsContent = `Current Medication:\nå°å¤§é†«é™¢: ${getVal('hist_current_med_ntuh', 'nil')}\nOther: ${getVal('hist_current_med_other', 'denied')}\nä¸­è‰è—¥: ${getVal('hist_current_med_tcm', 'denied')}\nä¿å¥é£Ÿå“: ${getVal('hist_current_med_supplements', 'denied')}`;
        const allergyContent = `Allergy:\n- Medication Allergy: ${medAllergyStr}\n- Medication ADR: ${getVal('hist_med_adr', 'unknown')}\n- Allergy to Medical Device and Materials: ${deviceAllergyStr}`;
        const familyHistoryContent = `Family History:\n${fhStr}`;
        const toccContent = `TOCC:\n- Travel history: ${getVal('hist_tocc_travel', 'denied')}\n- Occupation: ${getVal('hist_tocc_occupation', 'N/A')}\n- Cluster and contact: ${getVal('hist_tocc_cluster', 'denied')}`;
        const socialContent = `Social History:\n- Alcohol: ${getVal('hist_abc_alcohol', 'denied')}\n- Betel nuts: ${getVal('hist_abc_betel', 'denied')}\n- Smoking: ${getVal('hist_abc_smoking', 'denied')}`;

        return [historyContent, pmhContent, pshContent, hospContent, medsContent, allergyContent, familyHistoryContent, toccContent, socialContent].join('\n\n');
    };

    const generateNotePreview = () => {
        noteOutputEl.innerHTML = '';

        // EMR-formatted Chief Complaint
        const chiefComplaintContent = `Informant: ${getVal('informant', 'patient and EMR')}\n${getVal('ccpi', 'Not specified')}`;
        addSectionToOutput('ä¸»è¨´(Chief Complaint)', chiefComplaintContent, noteOutputEl);

        // EMR-formatted Patient History
        const historyBlockContent = assembleHistoryBlock();
        addSectionToOutput('ç—…å²(Patient History)', historyBlockContent, noteOutputEl);

        // Psychosocial Assessment
        const psychosocialContent = getVal('psychosocial_assessment', 'pending');
        addSectionToOutput('ç¤¾æœƒå¿ƒç†ç›¸é—œè©•ä¼°(Psychosocial Assessment)', psychosocialContent, noteOutputEl);

        // Review of Systems
        const rosContent = compileROS();
        addSectionToOutput('ç³»çµ±æ€§å›é¡§(Review of Systems)', rosContent, noteOutputEl);

        // EMR-formatted Physical Examination
        let peText = '';
        const vitalsText = `BH: ${getVal('vitals_bh', '--')} cm,  BW: ${getVal('vitals_bw', '--')} kg,\nT: ${getVal('vitals_t', '--')} Â°C,  P: ${getVal('vitals_p', '--')} bpm,  R: ${getVal('vitals_r', '--')} /min,\nBP: ${getVal('vitals_bp', '--/--')} mmHg,\nPain score: ${getVal('vitals_pain', '0')}`;
        peText = vitalsText + '\n\n';

        const peDetails = getVal('pe_details', '');
        if (peDetails) peText += peDetails + '\n\n';

        // Neurological section
        peText += `[Neurological Examination]\n- Consciousness: ${getVal('pe_neuro_conscious', 'alert and oriented, E4V5M6')}\n- Muscle power: ${getVal('pe_neuro_power', 'intact and symmetric')}\n- Gait: ${getVal('pe_neuro_gait', 'steady')}\n\n`;

        // Other PE sections with checkboxes
        document.querySelectorAll('#peSection details:not(:first-of-type)').forEach(det => {
            const title = det.querySelector('summary').textContent.trim();
            if (title === "Neurological Examination") return;
            const items = det.querySelectorAll('input[type="checkbox"]');
            const positiveItems = Array.from(items).filter(cb => cb.checked).map(cb => cb.parentElement.textContent.trim());
            if (positiveItems.length > 0) {
                peText += `[${title}]\n- ${positiveItems.join(', ')}\n\n`;
            }
        });

        addSectionToOutput('èº«é«”è¨ºå¯Ÿ(Physical Examination)', peText.trim(), noteOutputEl);

        // Imaging Report
        const imagingContent = getVal('imaging_report', 'nil');
        addSectionToOutput('å½±åƒå ±å‘Š(Imaging Report)', imagingContent, noteOutputEl);

        // Pathology Report
        const pathologyContent = getVal('pathology_report', 'nil');
        addSectionToOutput('ç—…ç†å ±å‘Š(Pathology Report)', pathologyContent, noteOutputEl);

        // Tentative Diagnosis
        const diagnosisContent = `[Active]\n${getVal('diagnosis_active', 'Not specified')}\n\n[Underlying]\n${getVal('diagnosis_underlying', 'Not specified')}`;
        addSectionToOutput('è‡†æ–·(Tentative Diagnosis)', diagnosisContent, noteOutputEl);

        // EMR-formatted SOAP (Medical Needs and Care Plan)
        const soapContent = `${getVal('plan_age_sex', '*--')}\n\nS:\n- ${getVal('ccpi', 'Not specified')}\n\nO:\n[General]\n- vital signs: stable\n- Consciousness: ${getVal('pe_neuro_conscious', 'E4V5M6')}\n\n[PE]\n${getVal('plan_pe_findings', 'See PE section')}\n\n[lab]\n${getVal('plan_lab_data', '- pending')}\n\n[image]\n- CXR ${getVal('plan_cxr_date', '')}: ${getVal('plan_cxr_interp', '(-)')}\n- ECG ${getVal('plan_ekg_date', '')}: ${getVal('plan_ekg_interp', 'NSR')}\n\nA:\n[Active]\n${getVal('plan_assessment_active', getVal('diagnosis_active', 'Not specified'))}\n\n[Underlying]\n${getVal('plan_assessment_underlying', getVal('diagnosis_underlying', 'Not specified'))}\n\nP:\n${getVal('plan_plan', '- symptomatic treatment')}\n\nTreatment goal:\n- ${getVal('plan_treatment_goal', 'clinical stability')}`;
        addSectionToOutput('é†«ç™‚éœ€æ±‚èˆ‡æ²»ç™‚è¨ˆç•«(Medical Needs and Care Plan)', soapContent, noteOutputEl);

        // Discharge Planning
        const dischargePlanContent = `ç®¡è·¯ç•™ç½®ç‹€æ³ï¼š${getVal('dp_catheter', 'Nil')}\næ—¥å¸¸ç”Ÿæ´»åŠŸèƒ½åˆ†æ•¸ï¼š${getVal('dp_adl', '100')}\né æœŸå‡ºé™¢å¾Œå±…ä½å ´æ‰€ï¼š${getVal('dp_residence', 'èˆ‡å®¶äººåŒä½')}\né æœŸå‡ºé™¢å¾Œä¸»è¦ç…§é¡§è€…ï¼š${getVal('dp_caregiver', 'è‡ªå·±')}\nå‡ºé™¢è¦åŠƒæ”¶æ¡ˆç¯©æª¢ï¼š${getVal('dp_screening', 'ä¸€èˆ¬ç—…æ‚£')}`;
        addSectionToOutput('å‡ºé™¢è¦åŠƒ(Discharge Planning)', dischargePlanContent, noteOutputEl);
    };

    // --- INITIALIZATION & EVENT LISTENERS ---
    allSections.forEach(section => {
        const block = document.createElement('div');
        block.className = 'block';
        block.dataset.sectionId = section.id;
        block.innerHTML = `<h2>${section.dataset.title || 'Section'}</h2>`;
        blockContainer.appendChild(block);
        blocks[section.id] = block;
    });

    const openModal = (sectionId) => {
        const section = document.getElementById(sectionId);
        if (section) {
            modalBody.appendChild(section);
            modalOverlay.style.display = 'flex';
            setTimeout(() => { modalOverlay.classList.add('active'); }, 10);
        }
    };

    const closeModal = () => {
        const section = modalBody.querySelector('section');
        modalOverlay.classList.remove('active');
        setTimeout(() => {
            modalOverlay.style.display = 'none';
            if (section) {
                sectionsContainer.appendChild(section);
                saveData();
            }
        }, 300);
    };

    blockContainer.addEventListener('click', e => e.target.closest('.block') && openModal(e.target.closest('.block').dataset.sectionId));
    modalClose.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', e => (e.target === modalOverlay) && closeModal());

    // Auto-save on any input change
    sectionsContainer.addEventListener('input', saveData);

    // Settings Menu
    const settingsContainer = document.getElementById('settings-container');
    settingsGear.addEventListener('click', () => settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block');
    document.addEventListener('click', (e) => {
        if (!settingsContainer.contains(e.target) && settingsMenu.style.display === 'block') {
            settingsMenu.style.display = 'none';
        }
    });

    clearDataBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to clear all data for a new patient? This cannot be undone.')) {
            localStorage.removeItem(STORAGE_KEY_DATA);
            location.reload();
        }
    });

    backgroundInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            const bgDataUrl = event.target.result;
            document.body.style.backgroundImage = `url(${bgDataUrl})`;
            localStorage.setItem(STORAGE_KEY_BG, bgDataUrl);
        };
        reader.readAsDataURL(file);
    });

    resetBackgroundBtn.addEventListener('click', () => {
        document.body.style.backgroundImage = `linear-gradient(to bottom, var(--bg-start), var(--bg-end))`;
        localStorage.removeItem(STORAGE_KEY_BG);
    });

    // Copy Buttons
    copyFullNoteBtn.addEventListener('click', () => {
        const fullText = noteOutputEl.innerText;
        navigator.clipboard.writeText(fullText).then(() => showToast('Full Note Copied!'));
    });

    copyHistoryBtn.addEventListener('click', () => {
        const historyText = assembleHistoryBlock();
        navigator.clipboard.writeText(historyText).then(() => showToast('History Block Copied!'));
    });

    outputContainer.addEventListener('click', e => {
        const btn = e.target.closest('.copy-section-btn');
        if (btn) {
            const content = btn.closest('.output-section').querySelector('.output-content').innerText;
            navigator.clipboard.writeText(content).then(() => {
                const originalText = btn.textContent;
                btn.textContent = 'âœ”ï¸';
                setTimeout(() => { btn.textContent = originalText; }, 1500);
            });
        }
    });

    // --- Initialize ---
    checkApiKey();
    loadData();
});
</script>
</body>
</html>